<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudentStay Boarding House Investment - Real Property Investment Platform</title>
    <meta name="description" content="Invest in real boarding house property and earn monthly dividends. Secure your financial future with tangible real estate investment.">
    <meta name="keywords" content="boarding house investment, real estate, property investment, dividends, passive income">
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iNCIgZmlsbD0iIzY2N2VlYSIvPgo8cGF0aCBkPSJNOCAxMkwxNiA2TDI0IDEyVjI0SDhWMTJaIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiIGZpbGw9Im5vbmUiLz4KPHJlY3QgeD0iMTIiIHk9IjE2IiB3aWR0aD0iOCIgaGVpZ2h0PSI4IiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiIGZpbGw9Im5vbmUiLz4KPC9zdmc+">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        body {
            box-sizing: border-box;
        }
        
        .investment-slot {
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid #d1d5db;
        }
        
        .investment-slot:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .available { background: linear-gradient(135deg, #10b981, #059669); }
        .pending { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .sold { background: linear-gradient(135deg, #dc2626, #b91c1c); }
        
        .building-container {
            background: linear-gradient(135deg, #1e293b, #334155);
            border-radius: 20px;
            padding: 40px 60px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.25);
            min-height: 1200px;
            width: 100%;
        }
        
        .floor-label {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .modal {
            backdrop-filter: blur(10px);
            background: rgba(0,0,0,0.7);
        }
        
        .form-container {
            background: linear-gradient(135deg, #ffffff, #f8fafc);
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.25);
        }
        
        .luxury-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .gold-accent {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .status-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .status-online { background-color: #10b981; }
        .status-offline { background-color: #ef4444; }
        .status-loading { background-color: #f59e0b; }
    </style>
</head>
<body class="min-h-screen luxury-gradient">
    <!-- Connection Status Indicator -->
    <div id="connectionStatus" class="status-indicator status-loading">
        üîÑ Connecting to database...
    </div>

    <!-- Header -->
    <header class="text-white py-8">
        <div class="container mx-auto px-6 text-center">
            <h1 class="text-5xl font-bold mb-4">
                <span class="gold-accent">StudentStay Boarding House</span>
            </h1>
            <p class="text-xl opacity-90 mb-6">Premium Investment Opportunity</p>
            

            
            <!-- Quick Action Buttons -->
            <div class="flex justify-center gap-4 mb-6">
                <button onclick="showPortfolioDashboard()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors">
                    üíº My Portfolio
                </button>
                <button onclick="showAffiliateProgram()" class="bg-orange-600 hover:bg-orange-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors">
                    ü§ù Affiliate Program
                </button>
                <button onclick="showAffiliateDashboard()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors">
                    üìä Affiliate Dashboard
                </button>
            </div>
            
            <!-- Community Links -->
            <div class="flex justify-center gap-4 mb-6">
                <a href="https://t.me/+d_wxE9CigKA3OTA1" target="_blank" rel="noopener noreferrer" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold transition-colors">
                    üì± Join Telegram Group
                </a>
                <a href="https://ric3rd.github.io/Student-Stay/" target="_blank" rel="noopener noreferrer" class="bg-purple-500 hover:bg-purple-600 text-white px-6 py-3 rounded-lg font-semibold transition-colors">
                    üìñ More Project Info
                </a>
            </div>
            

            
            <div class="bg-white/10 backdrop-blur-sm rounded-lg p-6 max-w-4xl mx-auto">
                <h2 class="text-2xl font-semibold mb-4">Investment Overview</h2>
                <div class="grid md:grid-cols-3 gap-6 text-center">
                    <div>
                        <div class="text-3xl font-bold gold-accent">‚Ç±3,000,000</div>
                        <div class="text-sm opacity-80">Total Funding Goal</div>
                    </div>
                    <div>
                        <div class="text-3xl font-bold gold-accent">Real Property</div>
                        <div class="text-sm opacity-80">Boarding House Construction</div>
                    </div>
                    <div>
                        <div class="text-3xl font-bold gold-accent">Dividends</div>
                        <div class="text-sm opacity-80">Operational Returns</div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Admin Panel Toggle -->
    <div class="fixed top-4 right-4 z-50">
        <button onclick="toggleAdminPanel()" class="bg-gray-800 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors">
            Admin Panel
        </button>
    </div>

    <!-- Building Visualization -->
    <main class="container mx-auto px-6 pb-12">
        <div class="building-container max-w-6xl mx-auto">
            <h2 class="text-white text-3xl font-bold text-center mb-8">Select Your Investment Unit</h2>
            
            <!-- Loading indicator -->
            <div id="buildingLoading" class="text-center py-12">
                <div class="loading-spinner"></div>
                <p class="text-white mt-4">Loading investment units...</p>
            </div>
            
            <!-- Building floors will be generated here -->
            <div id="buildingFloors" class="hidden">
                <!-- Floor 8 - Penthouse -->
                <div class="mb-6">
                    <div class="floor-label text-center">üè∞ Floor 8 - Penthouse (‚Ç±50,000)</div>
                    <div class="space-y-2" id="floor8"></div>
                </div>
                
                <!-- Floor 7 -->
                <div class="mb-6">
                    <div class="floor-label text-center">üè¢ Floor 7 - Premium (‚Ç±40,000)</div>
                    <div class="space-y-2" id="floor7"></div>
                </div>
                
                <!-- Floor 6 -->
                <div class="mb-6">
                    <div class="floor-label text-center">üè® Floor 6 - Deluxe (‚Ç±30,000)</div>
                    <div class="space-y-2" id="floor6"></div>
                </div>
                
                <!-- Floor 5 -->
                <div class="mb-6">
                    <div class="floor-label text-center">üè† Floor 5 - Standard (‚Ç±20,000)</div>
                    <div class="space-y-2" id="floor5"></div>
                </div>
                
                <!-- Floor 4 -->
                <div class="mb-6">
                    <div class="floor-label text-center">üèòÔ∏è Floor 4 - Basic (‚Ç±10,000)</div>
                    <div class="space-y-2" id="floor4"></div>
                </div>
                
                <!-- Floor 3 -->
                <div class="mb-6">
                    <div class="floor-label text-center">üè° Floor 3 - Economy (‚Ç±5,000)</div>
                    <div class="space-y-2" id="floor3"></div>
                </div>
                
                <!-- Floor 2 -->
                <div class="mb-6">
                    <div class="floor-label text-center">üèöÔ∏è Floor 2 - Starter (‚Ç±1,000)</div>
                    <div class="space-y-2" id="floor2"></div>
                </div>
                
                <!-- Floor 1 -->
                <div class="mb-6">
                    <div class="floor-label text-center">üè† Floor 1 - Micro (‚Ç±500)</div>
                    <div class="space-y-2" id="floor1"></div>
                </div>
            </div>
        </div>
        
        <!-- Monitoring Dashboard -->
        <div class="max-w-6xl mx-auto mt-8 bg-white/10 backdrop-blur-sm rounded-xl p-6">
            <h3 class="text-white text-2xl font-bold text-center mb-6">üìä Investment Monitoring Dashboard</h3>
            <div class="grid md:grid-cols-4 gap-6 text-center">
                <div class="bg-green-500/20 rounded-lg p-4">
                    <div class="text-3xl font-bold text-green-300" id="availableSlots">-</div>
                    <div class="text-sm text-white">Available Units</div>
                </div>
                <div class="bg-yellow-500/20 rounded-lg p-4">
                    <div class="text-3xl font-bold text-yellow-300" id="pendingSlots">-</div>
                    <div class="text-sm text-white">Pending Units</div>
                </div>
                <div class="bg-red-500/20 rounded-lg p-4">
                    <div class="text-3xl font-bold text-red-300" id="occupiedSlots">-</div>
                    <div class="text-sm text-white">Occupied Units</div>
                </div>
                <div class="bg-blue-500/20 rounded-lg p-4">
                    <div class="text-3xl font-bold text-blue-300" id="totalRaised">‚Ç±-</div>
                    <div class="text-sm text-white">Total Raised</div>
                </div>
            </div>
            
            <!-- Progress Bar -->
            <div class="mt-6">
                <div class="flex justify-between text-white mb-2">
                    <span>Progress to Goal</span>
                    <span id="progressPercent">-%</span>
                </div>
                <div class="w-full bg-gray-700 rounded-full h-4">
                    <div id="progressBar" class="bg-gradient-to-r from-green-400 to-blue-500 h-4 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
                <div class="text-center text-white mt-2">
                    <span id="progressText">‚Ç±- / ‚Ç±3,000,000</span>
                </div>
            </div>
        </div>
    </main>

    <!-- Investment Form Modal -->
    <div id="investmentModal" class="modal fixed inset-0 z-50 hidden items-center justify-center p-4">
        <div class="form-container max-w-md w-full max-h-[90vh] overflow-y-auto p-8">
            <h3 class="text-2xl font-bold mb-6 text-center">Investment Application</h3>
            <form id="investmentForm" class="space-y-4">
                <input type="hidden" id="slotId" name="slotId">
                <input type="hidden" id="floorInfo" name="floorInfo">
                <input type="hidden" id="investmentAmount" name="investmentAmount">
                
                <div>
                    <label class="block text-sm font-medium mb-2">Full Name *</label>
                    <input type="text" id="fullName" name="fullName" required class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-purple-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">Email *</label>
                    <input type="email" id="email" name="email" required class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-purple-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">Mobile Number *</label>
                    <input type="tel" id="mobile" name="mobile" required class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-purple-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">Create Portfolio Password *</label>
                    <input type="password" id="portfolioPassword" name="portfolioPassword" required minlength="6" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-purple-500">
                    <div class="text-xs text-gray-500 mt-1">This password will be used to access your investment portfolio later</div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">Affiliate Number (Optional)</label>
                    <input type="text" id="affiliateNumber" name="affiliateNumber" placeholder="Enter affiliate number if referred" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-purple-500">
                    <div class="text-xs text-gray-500 mt-1">If someone referred you, enter their affiliate number to give them commission</div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">Mode of Payment *</label>
                    <select id="paymentMode" name="paymentMode" required class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-purple-500" onchange="showPaymentInstructions()">
                        <option value="">Select Payment Method</option>
                        <option value="GCash">GCash</option>
                        <option value="Palawan Pay">Palawan Pay</option>
                        <option value="Bank Transfer">Bank Transfer</option>
                        <option value="PayPal">PayPal</option>
                    </select>
                </div>
                
                <!-- Dynamic Payment Instructions -->
                <div id="paymentInstructions" class="hidden">
                    <!-- Payment instructions will be shown here based on selection -->
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">Preferred Dividend Method *</label>
                    <select id="dividendMode" name="dividendMode" required class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-purple-500">
                        <option value="">Select Dividend Method</option>
                        <option value="GCash">GCash</option>
                        <option value="Palawan Pay">Palawan Pay</option>
                        <option value="Bank Transfer">Bank Transfer</option>
                        <option value="PayPal">PayPal</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">Account Details for Dividends *</label>
                    <textarea id="accountDetails" name="accountDetails" required placeholder="Enter account number, name, etc." class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-purple-500 h-20"></textarea>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">Upload Photo</label>
                    <input type="file" id="photo" name="photo" accept="image/*" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-purple-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">Custom Display Text</label>
                    <input type="text" id="customText" name="customText" placeholder="Text to display on your slot" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-purple-500">
                </div>
                
                <div class="flex gap-3 pt-4">
                    <button type="button" onclick="closeModal()" class="flex-1 bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600 transition-colors">Cancel</button>
                    <button type="submit" class="flex-1 bg-purple-600 text-white py-3 rounded-lg hover:bg-purple-700 transition-colors">Submit Investment</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Admin Panel Modal -->
    <div id="adminModal" class="modal fixed inset-0 z-50 hidden items-center justify-center p-4">
        <div class="form-container max-w-6xl w-full p-8 max-h-[90vh] overflow-y-auto">
            <div id="adminLogin" class="text-center">
                <h3 class="text-2xl font-bold mb-6">Admin Login</h3>
                <div class="space-y-4 max-w-sm mx-auto">
                    <input type="text" id="adminUsername" placeholder="Username" class="w-full p-3 border rounded-lg" onkeypress="if(event.key==='Enter') adminLogin()">
                    <input type="password" id="adminPassword" placeholder="Password" class="w-full p-3 border rounded-lg" onkeypress="if(event.key==='Enter') adminLogin()">
                    <button onclick="adminLogin()" class="w-full bg-purple-600 text-white py-3 rounded-lg hover:bg-purple-700">Login</button>
                    <button onclick="closeAdminModal()" class="w-full bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600">Cancel</button>
                </div>
            </div>
            
            <div id="adminPanel" class="hidden">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold">Admin Panel</h3>
                    <div class="space-x-2">
                        <button onclick="closeAdminModal()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Close</button>
                    </div>
                </div>
                
                <!-- Admin Tabs -->
                <div class="flex mb-4 border-b">
                    <button onclick="showAdminTab('investments')" id="adminInvestmentTab" class="px-4 py-2 font-semibold border-b-2 border-blue-600 text-blue-600">Investments</button>
                    <button onclick="showAdminTab('affiliates')" id="adminAffiliateTab" class="px-4 py-2 font-semibold text-gray-500 hover:text-gray-700">Affiliates</button>
                    <button onclick="showAdminTab('settings')" id="adminSettingsTab" class="px-4 py-2 font-semibold text-gray-500 hover:text-gray-700">Settings</button>
                </div>
                
                <div id="adminInvestmentContent" class="space-y-4">
                    <!-- Investment content will be loaded here -->
                </div>
                
                <div id="adminAffiliateContent" class="space-y-4 hidden">
                    <!-- Affiliate management will be loaded here -->
                </div>
                
                <div id="adminSettingsContent" class="space-y-4 hidden">
                    <!-- Settings content will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Instructions Modal -->
    <div id="paymentModal" class="modal fixed inset-0 z-50 hidden items-center justify-center p-4">
        <div class="form-container max-w-lg w-full p-8 max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-bold mb-6 text-center">üí≥ Payment Instructions</h3>
            
            <div class="space-y-4">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <h4 class="font-bold text-blue-800 mb-2">üì± GCash / Palawan Pay</h4>
                    <p class="text-blue-700">Mobile Number: <strong>09606555951</strong></p>
                </div>
                
                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                    <h4 class="font-bold text-green-800 mb-2">üè¶ Bank Transfer</h4>
                    <p class="text-green-700">Bank: <strong>BPI</strong></p>
                    <p class="text-green-700">Account No: <strong>6889023641</strong></p>
                    <p class="text-green-700">Account Name: <strong>Ricardo Nacional III</strong></p>
                </div>
                
                <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                    <h4 class="font-bold text-purple-800 mb-2">üí∞ PayPal</h4>
                    <p class="text-purple-700">Email: <strong>ricardoiiinacional@gmail.com</strong></p>
                    <p class="text-purple-700">Mobile: <strong>09606555951</strong></p>
                </div>
                
                <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                    <h4 class="font-bold text-red-800 mb-2">üì∏ IMPORTANT: Verification Process</h4>
                    <p class="text-red-700 mb-2">After making payment:</p>
                    <ol class="text-red-700 text-sm list-decimal list-inside space-y-1">
                        <li>Take a screenshot of your payment confirmation</li>
                        <li>Join our Telegram group using this link:</li>
                    </ol>
                    <a href="https://t.me/+d_wxE9CigKA3OTA1" target="_blank" rel="noopener noreferrer" 
                       class="inline-block bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors mt-2">
                        üì± Join Telegram Group
                    </a>
                    <p class="text-red-700 text-sm mt-2">Send your payment screenshot in the Telegram group for verification.</p>
                </div>
            </div>
            
            <div class="flex gap-3 pt-6">
                <button onclick="closePaymentModal()" class="flex-1 bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600 transition-colors">Close</button>
            </div>
        </div>
    </div>

    <!-- Photo Viewer Modal -->
    <div id="photoModal" class="modal fixed inset-0 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-lg p-6 max-w-md w-full text-center">
            <img id="modalPhoto" src="" alt="Investor Photo" class="w-full h-64 object-cover rounded-lg mb-4">
            <div id="modalText" class="text-lg font-semibold mb-4"></div>
            <div class="flex gap-3">
                <button onclick="closePhotoModal()" class="flex-1 bg-gray-500 text-white py-2 rounded hover:bg-gray-600">Close</button>
                <button id="removeSlotBtn" onclick="removeSlot()" class="flex-1 bg-red-600 text-white py-2 rounded hover:bg-red-700 hidden">Remove (Admin)</button>
            </div>
        </div>
    </div>

    <!-- Portfolio Dashboard Modal -->
    <div id="portfolioModal" class="modal fixed inset-0 z-50 hidden items-center justify-center p-4">
        <div class="form-container max-w-4xl w-full p-8 max-h-[90vh] overflow-y-auto">
            <h3 class="text-3xl font-bold mb-6 text-center">üíº Investment Portfolio Dashboard</h3>
            
            <div id="portfolioLogin" class="text-center">
                <p class="mb-4 text-gray-600">Enter your email and portfolio password to view your investments</p>
                <div class="space-y-4 max-w-sm mx-auto">
                    <input type="email" id="portfolioEmail" placeholder="Enter your email address" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    <input type="password" id="portfolioPasswordLogin" placeholder="Enter your portfolio password" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    <button onclick="loadPortfolio()" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700">View Portfolio</button>
                    <button onclick="closePortfolioModal()" class="w-full bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600">Cancel</button>
                </div>
            </div>
            
            <div id="portfolioContent" class="hidden">
                <div class="grid md:grid-cols-4 gap-6 mb-6">
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-green-800" id="totalInvested">‚Ç±0</div>
                        <div class="text-sm text-green-600">Total Invested</div>
                    </div>
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-blue-800" id="dividendEarned">‚Ç±0</div>
                        <div class="text-sm text-blue-600">Dividend Earned</div>
                    </div>
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-red-800" id="dividendWithdrawn">‚Ç±0</div>
                        <div class="text-sm text-red-600">Dividend Withdrawn</div>
                    </div>
                    <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-purple-800" id="totalSlots">0</div>
                        <div class="text-sm text-purple-600">Investment Units</div>
                    </div>
                </div>
                
                <div id="portfolioInvestments" class="space-y-4">
                    <!-- Portfolio investments will be loaded here -->
                </div>
                
                <div class="flex gap-3 pt-6">
                    <button onclick="closePortfolioModal()" class="flex-1 bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600 transition-colors">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Affiliate Program Modal -->
    <div id="affiliateModal" class="modal fixed inset-0 z-50 hidden items-center justify-center p-4">
        <div class="form-container max-w-3xl w-full p-8 max-h-[90vh] overflow-y-auto">
            <h3 class="text-3xl font-bold mb-6 text-center">ü§ù Affiliate Program</h3>
            
            <div class="bg-gradient-to-r from-orange-100 to-yellow-100 border border-orange-200 rounded-lg p-6 mb-6">
                <h4 class="text-xl font-bold text-orange-800 mb-3">üí∞ Earn Commission by Referring Investors!</h4>
                <p class="text-orange-700 mb-4">Join our affiliate program and earn <strong>5% commission</strong> on every successful investment you refer!</p>
                
                <div class="grid md:grid-cols-2 gap-4">
                    <div class="bg-white/50 rounded-lg p-4">
                        <h5 class="font-bold text-orange-800 mb-2">How It Works:</h5>
                        <ol class="text-sm text-orange-700 list-decimal list-inside space-y-1">
                            <li>Register as an affiliate</li>
                            <li>Get your unique affiliate number</li>
                            <li>Share your number with friends & family</li>
                            <li>They enter your number when investing</li>
                            <li>Earn 5% on their investments</li>
                        </ol>
                    </div>
                    <div class="bg-white/50 rounded-lg p-4">
                        <h5 class="font-bold text-orange-800 mb-2">Commission Examples:</h5>
                        <ul class="text-sm text-orange-700 space-y-1">
                            <li>‚Ä¢ ‚Ç±1,000 investment = ‚Ç±50 commission</li>
                            <li>‚Ä¢ ‚Ç±10,000 investment = ‚Ç±500 commission</li>
                            <li>‚Ä¢ ‚Ç±50,000 investment = ‚Ç±2,500 commission</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <div id="affiliateRegistration">
                <h4 class="text-xl font-semibold mb-4">Register as Affiliate</h4>
                <form id="affiliateForm" class="space-y-4">
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                        <h5 class="font-bold text-blue-800 mb-2">Your Affiliate Number (Auto-Generated):</h5>
                        <div class="flex items-center gap-2">
                            <input type="text" id="generatedAffiliateNumber" readonly class="flex-1 p-2 bg-white border rounded text-center font-mono font-bold text-lg">
                            <button type="button" onclick="generateNewAffiliateNumber()" class="bg-blue-600 text-white px-3 py-2 rounded hover:bg-blue-700">Generate New</button>
                        </div>
                        <p class="text-blue-700 text-sm mt-2">This is your unique affiliate number. Save it - you'll need it to access your dashboard and earn commissions!</p>
                    </div>
                    
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Full Name *</label>
                            <input type="text" id="affiliateName" name="affiliateName" required class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-orange-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Email *</label>
                            <input type="email" id="affiliateEmail" name="affiliateEmail" required class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-orange-500">
                        </div>
                    </div>
                    
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Mobile Number *</label>
                            <input type="tel" id="affiliateMobile" name="affiliateMobile" required class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-orange-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Preferred Commission Method *</label>
                            <select id="affiliatePayment" name="affiliatePayment" required class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-orange-500">
                                <option value="">Select Payment Method</option>
                                <option value="GCash">GCash</option>
                                <option value="Palawan Pay">Palawan Pay</option>
                                <option value="Bank Transfer">Bank Transfer</option>
                                <option value="PayPal">PayPal</option>
                            </select>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2">Payment Account Details *</label>
                        <textarea id="affiliateAccountDetails" name="affiliateAccountDetails" required placeholder="Enter account number, name, etc." class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-orange-500 h-20"></textarea>
                    </div>
                    
                    <div class="flex gap-3 pt-4">
                        <button type="button" onclick="closeAffiliateModal()" class="flex-1 bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600 transition-colors">Cancel</button>
                        <button type="submit" class="flex-1 bg-orange-600 text-white py-3 rounded-lg hover:bg-orange-700 transition-colors">Register as Affiliate</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Budget Recommendation Modal -->
    <div id="budgetModal" class="modal fixed inset-0 z-50 hidden items-center justify-center p-4">
        <div class="form-container max-w-2xl w-full p-8 max-h-[90vh] overflow-y-auto">
            <h3 class="text-3xl font-bold mb-6 text-center">üí° Find Your Perfect Investment</h3>
            
            <div class="bg-gradient-to-r from-purple-100 to-blue-100 border border-purple-200 rounded-lg p-6 mb-6">
                <h4 class="text-xl font-bold text-purple-800 mb-3">üéØ Let us recommend the best investment for your budget!</h4>
                <p class="text-purple-700">Enter your budget and we'll show you the perfect investment slots that match your financial capacity.</p>
            </div>
            
            <div class="space-y-6">
                <div>
                    <label class="block text-lg font-semibold mb-3">üí∞ What's your investment budget?</label>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                        <button onclick="setBudget(500)" class="budget-btn bg-gray-100 hover:bg-purple-100 border-2 border-gray-300 hover:border-purple-500 p-3 rounded-lg text-center transition-all">
                            <div class="font-bold">‚Ç±500</div>
                            <div class="text-xs text-gray-600">Micro</div>
                        </button>
                        <button onclick="setBudget(1000)" class="budget-btn bg-gray-100 hover:bg-purple-100 border-2 border-gray-300 hover:border-purple-500 p-3 rounded-lg text-center transition-all">
                            <div class="font-bold">‚Ç±1,000</div>
                            <div class="text-xs text-gray-600">Starter</div>
                        </button>
                        <button onclick="setBudget(5000)" class="budget-btn bg-gray-100 hover:bg-purple-100 border-2 border-gray-300 hover:border-purple-500 p-3 rounded-lg text-center transition-all">
                            <div class="font-bold">‚Ç±5,000</div>
                            <div class="text-xs text-gray-600">Economy</div>
                        </button>
                        <button onclick="setBudget(10000)" class="budget-btn bg-gray-100 hover:bg-purple-100 border-2 border-gray-300 hover:border-purple-500 p-3 rounded-lg text-center transition-all">
                            <div class="font-bold">‚Ç±10,000</div>
                            <div class="text-xs text-gray-600">Basic</div>
                        </button>
                        <button onclick="setBudget(20000)" class="budget-btn bg-gray-100 hover:bg-purple-100 border-2 border-gray-300 hover:border-purple-500 p-3 rounded-lg text-center transition-all">
                            <div class="font-bold">‚Ç±20,000</div>
                            <div class="text-xs text-gray-600">Standard</div>
                        </button>
                        <button onclick="setBudget(30000)" class="budget-btn bg-gray-100 hover:bg-purple-100 border-2 border-gray-300 hover:border-purple-500 p-3 rounded-lg text-center transition-all">
                            <div class="font-bold">‚Ç±30,000</div>
                            <div class="text-xs text-gray-600">Deluxe</div>
                        </button>
                        <button onclick="setBudget(40000)" class="budget-btn bg-gray-100 hover:bg-purple-100 border-2 border-gray-300 hover:border-purple-500 p-3 rounded-lg text-center transition-all">
                            <div class="font-bold">‚Ç±40,000</div>
                            <div class="text-xs text-gray-600">Premium</div>
                        </button>
                        <button onclick="setBudget(50000)" class="budget-btn bg-gray-100 hover:bg-purple-100 border-2 border-gray-300 hover:border-purple-500 p-3 rounded-lg text-center transition-all">
                            <div class="font-bold">‚Ç±50,000</div>
                            <div class="text-xs text-gray-600">Penthouse</div>
                        </button>
                    </div>
                    
                    <div class="flex items-center gap-3">
                        <span class="text-sm font-medium">Or enter custom amount:</span>
                        <input type="number" id="customBudget" placeholder="‚Ç±0" min="500" max="50000" step="100" 
                               class="flex-1 p-3 border rounded-lg focus:ring-2 focus:ring-purple-500" 
                               onchange="setBudget(this.value)">
                    </div>
                </div>
                
                <div id="budgetRecommendation" class="hidden">
                    <!-- Recommendation content will be loaded here -->
                </div>
                
                <div class="flex gap-3 pt-4">
                    <button onclick="closeBudgetModal()" class="flex-1 bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600 transition-colors">Close</button>
                    <button id="investNowBtn" onclick="proceedToInvestment()" class="flex-1 bg-purple-600 text-white py-3 rounded-lg hover:bg-purple-700 transition-colors hidden">
                        üöÄ Invest Now
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Welcome Popup Modal -->
    <div id="welcomeModal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="form-container max-w-4xl w-full p-8 max-h-[90vh] overflow-y-auto">
            <div class="bg-gradient-to-r from-yellow-400/20 to-orange-400/20 backdrop-blur-sm rounded-xl p-6 border border-yellow-400/30">
                <div class="text-center">
                    <h2 class="text-3xl font-bold text-gray-800 mb-4">üè¢ INVEST IN REAL PROPERTY, EARN REAL DIVIDENDS üè¢</h2>
                    <p class="text-xl font-semibold mb-4">This is NOT a virtual investment - You're investing in an ACTUAL BOARDING HOUSE!</p>
                    
                    <div class="bg-white/80 rounded-lg p-6 mb-6 text-left max-w-3xl mx-auto">
                        <h3 class="text-xl font-bold text-blue-800 mb-4 text-center">üíù Welcome, Future Property Owner!</h3>
                        <p class="text-gray-700 mb-4 leading-relaxed text-center">
                            Own a piece of <strong>real boarding house property</strong> and earn monthly dividends! Investment options from ‚Ç±500 to ‚Ç±50,000 - every investment brings you closer to financial freedom.
                        </p>
                        <div class="bg-green-50 border-l-4 border-green-400 p-4 rounded">
                            <p class="text-green-800 font-semibold text-center">
                                üåü Start building your wealth today - your future self will thank you! üåü
                            </p>
                        </div>
                    </div>
                    <div class="grid md:grid-cols-2 gap-4 text-left mb-6">
                        <div class="bg-white/10 rounded-lg p-4">
                            <h3 class="font-bold text-yellow-600 mb-2">‚úÖ GUARANTEED REAL PROPERTY</h3>
                            <ul class="text-sm space-y-1 text-gray-700">
                                <li>‚Ä¢ Physical boarding house construction</li>
                                <li>‚Ä¢ Tangible real estate investment</li>
                                <li>‚Ä¢ Legal property documentation</li>
                                <li>‚Ä¢ Prime location for students</li>
                            </ul>
                        </div>
                        <div class="bg-white/10 rounded-lg p-4">
                            <h3 class="font-bold text-green-600 mb-2">üí∞ MONTHLY DIVIDEND PAYMENTS</h3>
                            <ul class="text-sm space-y-1 text-gray-700">
                                <li>‚Ä¢ Regular rental income distribution</li>
                                <li>‚Ä¢ Paid directly to your chosen account</li>
                                <li>‚Ä¢ Transparent profit sharing system</li>
                                <li>‚Ä¢ Long-term passive income stream</li>
                                <li>‚Ä¢ ‚ö†Ô∏è Dividends start AFTER building completion</li>
                            </ul>
                        </div>
                    </div>
                    <p class="text-xl font-bold mb-6 text-yellow-600">
                        üéØ SECURE YOUR FINANCIAL FUTURE - INVEST IN REAL PROPERTY TODAY! üéØ
                    </p>
                    
                    <div class="flex gap-4 justify-center">
                        <button onclick="closeWelcomeModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-4 rounded-lg font-bold text-lg transition-colors">
                            üè† VIEW INVESTMENT UNITS
                        </button>
                        <button onclick="showBudgetRecommendationFromWelcome()" class="bg-purple-600 hover:bg-purple-700 text-white px-8 py-4 rounded-lg font-bold text-lg transition-colors">
                            üí° GET INVESTMENT RECOMMENDATION
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Affiliate Dashboard Modal -->
    <div id="affiliateDashboardModal" class="modal fixed inset-0 z-50 hidden items-center justify-center p-4">
        <div class="form-container max-w-4xl w-full p-8 max-h-[90vh] overflow-y-auto">
            <h3 class="text-3xl font-bold mb-6 text-center">üìä Affiliate Dashboard</h3>
            
            <div id="affiliateDashboardLogin" class="text-center">
                <p class="mb-4 text-gray-600">Enter your affiliate number to view your dashboard</p>
                <div class="space-y-4 max-w-sm mx-auto">
                    <input type="text" id="affiliateDashboardNumber" placeholder="Enter your affiliate number" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-green-500">
                    <button onclick="loadAffiliateDashboard()" class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700">View Dashboard</button>
                    <button onclick="closeAffiliateDashboardModal()" class="w-full bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600">Cancel</button>
                </div>
            </div>
            
            <div id="affiliateDashboardContent" class="hidden">
                <div class="grid md:grid-cols-5 gap-4 mb-6">
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-green-800" id="affiliateTotalEarned">‚Ç±0</div>
                        <div class="text-sm text-green-600">Total Earned</div>
                    </div>
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-blue-800" id="affiliateAvailableBalance">‚Ç±0</div>
                        <div class="text-sm text-blue-600">Available Balance</div>
                    </div>
                    <div class="bg-orange-50 border border-orange-200 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-orange-800" id="affiliatePendingEarnings">‚Ç±0</div>
                        <div class="text-sm text-orange-600">Pending Earnings</div>
                    </div>
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-red-800" id="affiliateTotalWithdrawn">‚Ç±0</div>
                        <div class="text-sm text-red-600">Total Withdrawn</div>
                    </div>
                    <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-purple-800" id="affiliateNumber">-</div>
                        <div class="text-sm text-purple-600">Your Affiliate #</div>
                    </div>
                </div>
                
                <div class="grid md:grid-cols-2 gap-4 mb-6">
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 text-center">
                        <div class="text-xl font-bold text-gray-800" id="affiliateTotalReferrals">0</div>
                        <div class="text-sm text-gray-600">Total Referrals</div>
                    </div>
                    <div class="bg-indigo-50 border border-indigo-200 rounded-lg p-4 text-center">
                        <div class="text-xl font-bold text-indigo-800" id="affiliateWithdrawalCount">0</div>
                        <div class="text-sm text-indigo-600">Total Withdrawals</div>
                    </div>
                </div>
                
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
                    <h4 class="font-bold text-yellow-800 mb-2">üìã How to Share Your Affiliate Number:</h4>
                    <p class="text-yellow-700 text-sm mb-2">Give your affiliate number to people you want to refer. When they invest, they should enter your number in the "Affiliate Number" field to give you 5% commission.</p>
                    <div class="flex items-center gap-2 mt-3">
                        <input type="text" id="affiliateNumberToCopy" readonly class="flex-1 p-2 bg-white border rounded text-center font-mono font-bold">
                        <button onclick="copyAffiliateNumber()" class="bg-yellow-600 text-white px-4 py-2 rounded hover:bg-yellow-700">Copy</button>
                    </div>
                </div>
                
                <div id="affiliateReferralsList" class="space-y-4">
                    <!-- Referrals will be loaded here -->
                </div>
                
                <div class="flex gap-3 pt-6">
                    <button onclick="closeAffiliateDashboardModal()" class="flex-1 bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600 transition-colors">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== FIREBASE CONFIGURATION =====
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCkc3FBjQDUeKxOjG0BnoXwGjssurr9xNc",
            authDomain: "studentstay-997a0.firebaseapp.com",
            projectId: "studentstay-997a0",
            storageBucket: "studentstay-997a0.firebasestorage.app",
            messagingSenderId: "471410985399",
            appId: "1:471410985399:web:b765f88c1f4e4e77ab0032",
            measurementId: "G-HS1NRL5WL6"
        };

        // Initialize Firebase
        let db = null;
        let isFirebaseConfigured = false;

        // ===== DATA STORAGE =====
        let investments = {};
        let affiliates = {};
        let adminCredentials = { username: "admin", password: "123" };
        let isAdminLoggedIn = false;
        let currentPhotoSlot = null;
        let isOnline = false;

        // ===== FIREBASE FUNCTIONS =====
        
        // Initialize Firebase
        function initializeFirebase() {
            try {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                isFirebaseConfigured = true;
                console.log('Firebase initialized successfully');
                return true;
            } catch (error) {
                console.error('Firebase initialization failed:', error);
                isFirebaseConfigured = false;
                return false;
            }
        }

        // Update connection status indicator
        function updateConnectionStatus(status, message) {
            const indicator = document.getElementById('connectionStatus');
            indicator.className = `status-indicator status-${status}`;
            
            const icons = {
                online: 'üü¢',
                offline: 'üî¥',
                loading: 'üîÑ'
            };
            
            indicator.textContent = `${icons[status]} ${message}`;
            isOnline = (status === 'online');
        }

        // Load data from Firebase
        async function loadFromFirebase(collection) {
            if (!isFirebaseConfigured) {
                console.log(`Firebase not configured, using localStorage for ${collection}`);
                return null;
            }

            try {
                updateConnectionStatus('loading', 'Loading data...');
                
                const snapshot = await db.collection(collection).get();
                const data = {};
                
                snapshot.forEach(doc => {
                    data[doc.id] = doc.data();
                });
                
                updateConnectionStatus('online', 'Connected to Firebase');
                return data;
            } catch (error) {
                console.error(`Error loading ${collection}:`, error);
                updateConnectionStatus('offline', 'Using local storage');
                return null;
            }
        }

        // Save data to Firebase
        async function saveToFirebase(collection, docId, data) {
            if (!isFirebaseConfigured) {
                console.log(`Firebase not configured, saving to localStorage for ${collection}`);
                return false;
            }

            try {
                updateConnectionStatus('loading', 'Saving data...');
                
                await db.collection(collection).doc(docId).set(data, { merge: true });
                
                updateConnectionStatus('online', 'Data saved successfully');
                return true;
            } catch (error) {
                console.error(`Error saving ${collection}:`, error);
                updateConnectionStatus('offline', 'Save failed - using local storage');
                return false;
            }
        }

        // Save entire collection to Firebase
        async function saveCollectionToFirebase(collection, dataObject) {
            if (!isFirebaseConfigured) {
                console.log(`Firebase not configured, saving to localStorage for ${collection}`);
                return false;
            }

            try {
                updateConnectionStatus('loading', 'Saving collection...');
                
                const batch = db.batch();
                
                Object.entries(dataObject).forEach(([docId, data]) => {
                    const docRef = db.collection(collection).doc(docId);
                    batch.set(docRef, data, { merge: true });
                });
                
                await batch.commit();
                
                updateConnectionStatus('online', 'Collection saved successfully');
                return true;
            } catch (error) {
                console.error(`Error saving collection ${collection}:`, error);
                updateConnectionStatus('offline', 'Save failed - using local storage');
                return false;
            }
        }

        // Initialize data loading
        async function initializeData() {
            updateConnectionStatus('loading', 'Connecting to Firebase...');
            
            // Initialize Firebase
            const firebaseInitialized = initializeFirebase();
            
            if (!firebaseInitialized) {
                updateConnectionStatus('offline', 'Firebase connection failed');
                alert('‚ùå Firebase connection failed. Please check your configuration.');
                return;
            }
            
            // Load from Firebase
            try {
                const [investmentData, affiliateData, adminData] = await Promise.all([
                    loadFromFirebase('investments'),
                    loadFromFirebase('affiliates'),
                    loadFromFirebase('admin')
                ]);
                
                investments = investmentData || {};
                affiliates = affiliateData || {};
                
                // Load admin credentials from Firebase if they exist
                if (adminData && adminData.credentials) {
                    adminCredentials = adminData.credentials;
                }
                
                updateConnectionStatus('online', 'Connected to Firebase');
                
                // Initialize the building after data is loaded
                initializeBuilding();
                updateDashboard();
            } catch (error) {
                console.error('Failed to load from Firebase:', error);
                updateConnectionStatus('offline', 'Failed to load data from Firebase');
                alert('‚ùå Failed to load data from Firebase. Please check your internet connection.');
            }
        }

        // Save data to Firebase
        async function saveData(dataType, data) {
            if (!isFirebaseConfigured) {
                throw new Error('Firebase not configured');
            }
            
            await saveCollectionToFirebase(dataType, data);
        }

        // Save single document to Firebase
        async function saveSingleData(collection, docId, data) {
            if (!isFirebaseConfigured) {
                throw new Error('Firebase not configured');
            }
            
            await saveToFirebase(collection, docId, data);
        }

        // Refresh data from Firebase
        async function refreshData() {
            if (!isFirebaseConfigured) {
                alert('‚ùå Firebase not connected. Cannot refresh data.');
                return;
            }
            
            updateConnectionStatus('loading', 'Refreshing data...');
            
            try {
                const [investmentData, affiliateData] = await Promise.all([
                    loadFromFirebase('investments'),
                    loadFromFirebase('affiliates')
                ]);
                
                investments = investmentData || {};
                affiliates = affiliateData || {};
                
                // Refresh UI
                initializeBuilding();
                updateDashboard();
                
                if (isAdminLoggedIn) {
                    loadAdminInvestments();
                    loadAdminAffiliates();
                }
                
                updateConnectionStatus('online', 'Data refreshed successfully');
                alert('‚úÖ Data refreshed from Firebase!');
            } catch (error) {
                console.error('Failed to refresh data:', error);
                updateConnectionStatus('offline', 'Refresh failed');
                alert('‚ùå Failed to refresh data from Firebase');
            }
        }



        // ===== FLOOR CONFIGURATION =====
        const floorConfig = {
            floor8: { slots: 10, price: 50000, name: "Penthouse", icon: "üè∞", slotsPerRow: 10 },
            floor7: { slots: 20, price: 40000, name: "Premium", icon: "üè¢", slotsPerRow: 10 },
            floor6: { slots: 20, price: 30000, name: "Deluxe", icon: "üè®", slotsPerRow: 10 },
            floor5: { slots: 30, price: 20000, name: "Standard", icon: "üè†", slotsPerRow: 10 },
            floor4: { slots: 30, price: 10000, name: "Basic", icon: "üèòÔ∏è", slotsPerRow: 10 },
            floor3: { slots: 50, price: 5000, name: "Economy", icon: "üè°", slotsPerRow: 10 },
            floor2: { slots: 60, price: 1000, name: "Starter", icon: "üèöÔ∏è", slotsPerRow: 10 },
            floor1: { slots: 50, price: 500, name: "Micro", icon: "üè†", slotsPerRow: 10 }
        };

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', function() {
            initializeData();
            // Show welcome modal on page load
            showWelcomeModal();
        });

        // ===== WELCOME MODAL FUNCTIONS =====
        function showWelcomeModal() {
            const modal = document.getElementById('welcomeModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeWelcomeModal() {
            const modal = document.getElementById('welcomeModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        function showBudgetRecommendationFromWelcome() {
            closeWelcomeModal();
            showBudgetRecommendation();
        }

        // Initialize building
        function initializeBuilding() {
            // Show loading
            document.getElementById('buildingLoading').style.display = 'block';
            document.getElementById('buildingFloors').classList.add('hidden');
            
            setTimeout(() => {
                Object.keys(floorConfig).forEach(floorId => {
                    const floor = document.getElementById(floorId);
                    if (!floor) return;
                    
                    // Clear existing content
                    floor.innerHTML = '';
                    
                    const config = floorConfig[floorId];
                    
                    let currentRow = null;
                    let slotsInCurrentRow = 0;
                    
                    for (let i = 1; i <= config.slots; i++) {
                        // Create new row if needed
                        if (slotsInCurrentRow === 0) {
                            currentRow = document.createElement('div');
                            currentRow.className = 'flex gap-2 justify-center';
                            floor.appendChild(currentRow);
                        }
                        
                        const slot = document.createElement('div');
                        const slotKey = `${floorId}_${i}`;
                        slot.className = 'investment-slot w-12 h-12 rounded-lg flex items-center justify-center text-white font-bold text-xs';
                        slot.dataset.slotId = slotKey;
                        slot.dataset.floor = floorId;
                        slot.dataset.price = config.price;
                        slot.dataset.floorName = config.name;
                        
                        updateSlotAppearance(slot, slotKey);
                        
                        slot.addEventListener('click', () => handleSlotClick(slotKey, slot));
                        currentRow.appendChild(slot);
                        
                        slotsInCurrentRow++;
                        
                        // Reset row counter when row is full
                        if (slotsInCurrentRow >= config.slotsPerRow) {
                            slotsInCurrentRow = 0;
                        }
                    }
                });
                
                // Hide loading and show building
                document.getElementById('buildingLoading').style.display = 'none';
                document.getElementById('buildingFloors').classList.remove('hidden');
            }, 500);
        }

        function updateSlotAppearance(slot, slotKey) {
            const investment = investments[slotKey];
            
            if (!investment) {
                slot.className = slot.className.replace(/available|pending|sold/g, '') + ' available';
                slot.textContent = '';
                slot.style.backgroundImage = '';
            } else if (investment.status === 'pending') {
                slot.className = slot.className.replace(/available|pending|sold/g, '') + ' pending';
                slot.textContent = 'PENDING';
                slot.style.backgroundImage = '';
            } else if (investment.status === 'approved') {
                slot.className = slot.className.replace(/available|pending|sold/g, '') + ' sold';
                if (investment.photo) {
                    slot.style.backgroundImage = `url(${investment.photo})`;
                    slot.style.backgroundSize = 'cover';
                    slot.style.backgroundPosition = 'center';
                    slot.textContent = '';
                } else {
                    slot.textContent = investment.customText || 'SOLD';
                    slot.style.backgroundImage = '';
                }
            }
        }

        function handleSlotClick(slotKey, slot) {
            const investment = investments[slotKey];
            
            if (!investment) {
                // Available slot - open investment form
                openInvestmentForm(slotKey, slot);
            } else if (investment.status === 'approved') {
                // Sold slot - show photo/details
                showPhotoModal(investment, slotKey);
            }
            // Pending slots don't respond to clicks
        }

        function openInvestmentForm(slotKey, slot) {
            const slotNumber = generateSlotNumber(slotKey);
            const investmentAmount = parseInt(slot.dataset.price);
            const floorName = slot.dataset.floorName;
            
            document.getElementById('slotId').value = slotKey;
            document.getElementById('floorInfo').value = `${floorName} Floor`;
            document.getElementById('investmentAmount').value = investmentAmount;
            
            // Update the form header with investment details
            updateInvestmentFormHeader(slotNumber, floorName, investmentAmount);
            
            const modal = document.getElementById('investmentModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function generateSlotNumber(slotKey) {
            // Extract floor and unit number from slotKey (e.g., "floor8_5" -> "F8-05")
            const parts = slotKey.split('_');
            const floorNum = parts[0].replace('floor', '');
            const unitNum = parts[1].padStart(2, '0');
            return `F${floorNum}-${unitNum}`;
        }

        function updateInvestmentFormHeader(slotNumber, floorName, amount) {
            const existingHeader = document.querySelector('#investmentFormHeader');
            if (existingHeader) {
                existingHeader.remove();
            }
            
            const formContainer = document.querySelector('#investmentModal .form-container');
            const formTitle = formContainer.querySelector('h3');
            
            const headerDiv = document.createElement('div');
            headerDiv.id = 'investmentFormHeader';
            headerDiv.className = 'bg-gradient-to-r from-purple-100 to-blue-100 border border-purple-200 rounded-lg p-4 mb-6';
            headerDiv.innerHTML = `
                <div class="text-center">
                    <div class="text-lg font-bold text-purple-800 mb-2">üìç Investment Details</div>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div class="bg-white/50 rounded-lg p-3">
                            <div class="text-sm text-purple-600 font-medium">Unit Number</div>
                            <div class="text-xl font-bold text-purple-800">${slotNumber}</div>
                        </div>
                        <div class="bg-white/50 rounded-lg p-3">
                            <div class="text-sm text-purple-600 font-medium">Investment Amount</div>
                            <div class="text-xl font-bold text-green-600">‚Ç±${amount.toLocaleString()}</div>
                        </div>
                    </div>
                    <div class="mt-3 text-sm text-purple-700">
                        <strong>${floorName} Floor</strong> - Premium boarding house investment unit
                    </div>
                </div>
            `;
            
            formTitle.insertAdjacentElement('afterend', headerDiv);
        }

        function closeModal() {
            const modal = document.getElementById('investmentModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            document.getElementById('investmentForm').reset();
        }

        function showPhotoModal(investment, slotKey) {
            currentPhotoSlot = slotKey;
            document.getElementById('modalPhoto').src = investment.photo || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2Y3ZjdmNyIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiM5OTk5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5ObyBQaG90bzwvdGV4dD48L3N2Zz4=';
            document.getElementById('modalText').textContent = investment.customText || investment.fullName;
            document.getElementById('removeSlotBtn').classList.toggle('hidden', !isAdminLoggedIn);
            
            const modal = document.getElementById('photoModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closePhotoModal() {
            const modal = document.getElementById('photoModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            currentPhotoSlot = null;
        }

        function removeSlot() {
            if (currentPhotoSlot && isAdminLoggedIn) {
                delete investments[currentPhotoSlot];
                saveData('investments', investments);
                
                const slot = document.querySelector(`[data-slot-id="${currentPhotoSlot}"]`);
                updateSlotAppearance(slot, currentPhotoSlot);
                
                closePhotoModal();
                updateDashboard();
                alert('Investment slot removed successfully!');
            }
        }

        // ===== PAYMENT INSTRUCTIONS FUNCTION =====
        function showPaymentInstructions() {
            const paymentMode = document.getElementById('paymentMode').value;
            const instructionsDiv = document.getElementById('paymentInstructions');
            
            if (!paymentMode) {
                instructionsDiv.classList.add('hidden');
                return;
            }
            
            let instructionsHTML = '';
            
            switch(paymentMode) {
                case 'GCash':
                    instructionsHTML = `
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <h4 class="font-bold text-blue-800 mb-2">üì± GCash Payment Instructions</h4>
                            <p class="text-blue-700 mb-2"><strong>Mobile Number:</strong> 09606555951</p>
                            <p class="text-blue-700 text-sm mb-3">Send your investment amount to this GCash number.</p>
                            <div class="bg-blue-100 p-3 rounded text-sm">
                                <p class="text-blue-800 font-semibold mb-1">üì∏ IMPORTANT: After Payment</p>
                                <p class="text-blue-700">1. Take a screenshot of your payment confirmation</p>
                                <p class="text-blue-700">2. Join our Telegram group and send the screenshot for verification</p>
                                <a href="https://t.me/+d_wxE9CigKA3OTA1" target="_blank" rel="noopener noreferrer" 
                                   class="inline-block bg-blue-500 text-white px-3 py-1 rounded text-xs hover:bg-blue-600 transition-colors mt-2">
                                    üì± Join Telegram Group
                                </a>
                            </div>
                        </div>
                    `;
                    break;
                case 'Palawan Pay':
                    instructionsHTML = `
                        <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
                            <h4 class="font-bold text-orange-800 mb-2">üè™ Palawan Pay Instructions</h4>
                            <p class="text-orange-700 mb-2"><strong>Mobile Number:</strong> 09606555951</p>
                            <p class="text-orange-700 text-sm mb-3">Send your investment amount to this mobile number via Palawan Pay.</p>
                            <div class="bg-orange-100 p-3 rounded text-sm">
                                <p class="text-orange-800 font-semibold mb-1">üì∏ IMPORTANT: After Payment</p>
                                <p class="text-orange-700">1. Take a photo of your payment receipt</p>
                                <p class="text-orange-700">2. Join our Telegram group and send the receipt for verification</p>
                                <a href="https://t.me/+d_wxE9CigKA3OTA1" target="_blank" rel="noopener noreferrer" 
                                   class="inline-block bg-orange-500 text-white px-3 py-1 rounded text-xs hover:bg-orange-600 transition-colors mt-2">
                                    üì± Join Telegram Group
                                </a>
                            </div>
                        </div>
                    `;
                    break;
                case 'Bank Transfer':
                    instructionsHTML = `
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <h4 class="font-bold text-green-800 mb-2">üè¶ Bank Transfer Instructions</h4>
                            <div class="text-green-700 mb-3">
                                <p><strong>Bank:</strong> BPI</p>
                                <p><strong>Account Number:</strong> 6889023641</p>
                                <p><strong>Account Name:</strong> Ricardo Nacional III</p>
                            </div>
                            <div class="bg-green-100 p-3 rounded text-sm">
                                <p class="text-green-800 font-semibold mb-1">üì∏ IMPORTANT: After Payment</p>
                                <p class="text-green-700">1. Take a screenshot of your transfer confirmation</p>
                                <p class="text-green-700">2. Join our Telegram group and send the screenshot for verification</p>
                                <a href="https://t.me/+d_wxE9CigKA3OTA1" target="_blank" rel="noopener noreferrer" 
                                   class="inline-block bg-green-500 text-white px-3 py-1 rounded text-xs hover:bg-green-600 transition-colors mt-2">
                                    üì± Join Telegram Group
                                </a>
                            </div>
                        </div>
                    `;
                    break;
                case 'PayPal':
                    instructionsHTML = `
                        <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                            <h4 class="font-bold text-purple-800 mb-2">üí∞ PayPal Payment Instructions</h4>
                            <div class="text-purple-700 mb-3">
                                <p><strong>PayPal Email:</strong> ricardoiiinacional@gmail.com</p>
                                <p><strong>Mobile:</strong> 09606555951</p>
                            </div>
                            <div class="bg-purple-100 p-3 rounded text-sm">
                                <p class="text-purple-800 font-semibold mb-1">üì∏ IMPORTANT: After Payment</p>
                                <p class="text-purple-700">1. Take a screenshot of your PayPal payment confirmation</p>
                                <p class="text-purple-700">2. Join our Telegram group and send the screenshot for verification</p>
                                <a href="https://t.me/+d_wxE9CigKA3OTA1" target="_blank" rel="noopener noreferrer" 
                                   class="inline-block bg-purple-500 text-white px-3 py-1 rounded text-xs hover:bg-purple-600 transition-colors mt-2">
                                    üì± Join Telegram Group
                                </a>
                            </div>
                        </div>
                    `;
                    break;
            }
            
            instructionsDiv.innerHTML = instructionsHTML;
            instructionsDiv.classList.remove('hidden');
        }

        // ===== FORM SUBMISSION =====
        document.getElementById('investmentForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const slotId = formData.get('slotId');
            
            // Handle photo upload
            const photoFile = formData.get('photo');
            let photoDataUrl = null;
            
            if (photoFile && photoFile.size > 0) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    photoDataUrl = e.target.result;
                    saveInvestment(formData, slotId, photoDataUrl);
                };
                reader.readAsDataURL(photoFile);
            } else {
                saveInvestment(formData, slotId, null);
            }
        });

        async function saveInvestment(formData, slotId, photoDataUrl) {
            const affiliateNumber = formData.get('affiliateNumber');
            const slotNumber = generateSlotNumber(slotId);
            const paymentMode = formData.get('paymentMode');
            
            const investmentData = {
                fullName: formData.get('fullName'),
                email: formData.get('email'),
                mobile: formData.get('mobile'),
                portfolioPassword: formData.get('portfolioPassword'),
                affiliateNumber: affiliateNumber,
                paymentMode: paymentMode,
                dividendMode: formData.get('dividendMode'),
                accountDetails: formData.get('accountDetails'),
                customText: formData.get('customText'),
                photo: photoDataUrl,
                floorInfo: formData.get('floorInfo'),
                investmentAmount: formData.get('investmentAmount'),
                slotNumber: slotNumber,
                status: 'pending',
                timestamp: new Date().toISOString(),
                dividendEarned: 0,
                dividendWithdrawn: 0
            };
            
            // Add to local storage first
            investments[slotId] = investmentData;
            
            // Save to Firebase immediately with proper error handling
            if (isFirebaseConfigured && db) {
                try {
                    updateConnectionStatus('loading', 'Saving investment to Firebase...');
                    
                    // Save the individual investment document
                    await db.collection('investments').doc(slotId).set(investmentData);
                    
                    updateConnectionStatus('online', 'Investment saved to Firebase successfully');
                    console.log('Investment saved to Firebase:', slotId);
                } catch (error) {
                    console.error('Failed to save investment to Firebase:', error);
                    updateConnectionStatus('offline', 'Firebase save failed');
                    
                    // Try alternative save method
                    try {
                        await saveCollectionToFirebase('investments', investments);
                        updateConnectionStatus('online', 'Investment saved via collection update');
                    } catch (retryError) {
                        console.error('Collection save also failed:', retryError);
                        updateConnectionStatus('offline', 'All Firebase saves failed');
                    }
                }
            } else {
                console.log('Firebase not configured, investment saved locally only');
                updateConnectionStatus('offline', 'Firebase not available - saved locally');
            }
            
            // Process affiliate commission if affiliate number provided
            if (affiliateNumber) {
                await processAffiliateCommission(affiliateNumber, investmentData, slotId);
            }
            
            // Update slot appearance
            const slot = document.querySelector(`[data-slot-id="${slotId}"]`);
            updateSlotAppearance(slot, slotId);
            
            closeModal();
            updateDashboard();
            
            // Show payment instructions based on selected payment mode
            showPaymentInstructionsModal(paymentMode);
        }

        async function processAffiliateCommission(affiliateNumber, investmentData, slotId) {
            // Find affiliate by number
            const affiliate = Object.values(affiliates).find(aff => aff.affiliateNumber === affiliateNumber);
            
            if (affiliate) {
                const commission = Math.round(parseInt(investmentData.investmentAmount) * 0.05);
                
                // Add referral to affiliate's record
                if (!affiliate.referrals) affiliate.referrals = [];
                
                affiliate.referrals.push({
                    slotId: slotId,
                    investorName: investmentData.fullName,
                    investorEmail: investmentData.email,
                    investmentAmount: parseInt(investmentData.investmentAmount),
                    commission: commission,
                    status: 'pending',
                    date: new Date().toISOString()
                });
                
                affiliate.pendingCommissions = (affiliate.pendingCommissions || 0) + commission;
                
                // Update affiliate data
                const affiliateEmail = Object.keys(affiliates).find(email => affiliates[email].affiliateNumber === affiliateNumber);
                if (affiliateEmail) {
                    affiliates[affiliateEmail] = affiliate;
                    await saveData('affiliates', affiliates);
                }
            }
        }

        function showPaymentInstructionsModal(paymentMode) {
            // Show pending review message first
            alert('‚úÖ Investment Application Submitted!\n\n' +
                  'üìã Your application is now under review.\n\n' +
                  'üí≥ Next Step: Complete your payment using the instructions that will appear next.\n\n' +
                  'üì∏ After payment, take a screenshot and join our Telegram group to send proof of payment for verification.\n\n' +
                  '‚è≥ Your investment slot will be approved once payment is verified.');
            
            // Then show specific payment instructions
            setTimeout(() => {
                showSpecificPaymentInstructions(paymentMode);
            }, 1000);
        }

        function showSpecificPaymentInstructions(paymentMode) {
            const modal = document.getElementById('paymentModal');
            const container = modal.querySelector('.form-container');
            
            let instructionsHTML = '';
            
            switch(paymentMode) {
                case 'GCash':
                    instructionsHTML = `
                        <h3 class="text-2xl font-bold mb-6 text-center">üì± GCash Payment Instructions</h3>
                        <div class="space-y-4">
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
                                <h4 class="font-bold text-blue-800 mb-4 text-xl">üí≥ Send Payment via GCash</h4>
                                <div class="text-center mb-4">
                                    <div class="text-3xl font-bold text-blue-800 mb-2">09606555951</div>
                                    <p class="text-blue-700">Send your investment amount to this GCash number</p>
                                </div>
                            </div>
                            
                            <div class="bg-red-50 border border-red-200 rounded-lg p-6">
                                <h4 class="font-bold text-red-800 mb-3">üì∏ IMPORTANT: After Payment</h4>
                                <ol class="text-red-700 list-decimal list-inside space-y-2">
                                    <li>Take a screenshot of your GCash payment confirmation</li>
                                    <li>Join our Telegram group using the button below</li>
                                    <li>Send your payment screenshot in the group</li>
                                    <li>Wait for admin verification and approval</li>
                                </ol>
                                <a href="https://t.me/+d_wxE9CigKA3OTA1" target="_blank" rel="noopener noreferrer" 
                                   class="inline-block bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 transition-colors mt-4 w-full text-center">
                                    üì± Join Telegram Group for Verification
                                </a>
                            </div>
                        </div>
                    `;
                    break;
                case 'Palawan Pay':
                    instructionsHTML = `
                        <h3 class="text-2xl font-bold mb-6 text-center">üè™ Palawan Pay Instructions</h3>
                        <div class="space-y-4">
                            <div class="bg-orange-50 border border-orange-200 rounded-lg p-6">
                                <h4 class="font-bold text-orange-800 mb-4 text-xl">üí≥ Send Payment via Palawan Pay</h4>
                                <div class="text-center mb-4">
                                    <div class="text-3xl font-bold text-orange-800 mb-2">09606555951</div>
                                    <p class="text-orange-700">Send your investment amount to this mobile number</p>
                                </div>
                            </div>
                            
                            <div class="bg-red-50 border border-red-200 rounded-lg p-6">
                                <h4 class="font-bold text-red-800 mb-3">üì∏ IMPORTANT: After Payment</h4>
                                <ol class="text-red-700 list-decimal list-inside space-y-2">
                                    <li>Take a photo of your Palawan Pay receipt</li>
                                    <li>Join our Telegram group using the button below</li>
                                    <li>Send your payment receipt in the group</li>
                                    <li>Wait for admin verification and approval</li>
                                </ol>
                                <a href="https://t.me/+d_wxE9CigKA3OTA1" target="_blank" rel="noopener noreferrer" 
                                   class="inline-block bg-orange-500 text-white px-6 py-3 rounded-lg hover:bg-orange-600 transition-colors mt-4 w-full text-center">
                                    üì± Join Telegram Group for Verification
                                </a>
                            </div>
                        </div>
                    `;
                    break;
                case 'Bank Transfer':
                    instructionsHTML = `
                        <h3 class="text-2xl font-bold mb-6 text-center">üè¶ Bank Transfer Instructions</h3>
                        <div class="space-y-4">
                            <div class="bg-green-50 border border-green-200 rounded-lg p-6">
                                <h4 class="font-bold text-green-800 mb-4 text-xl">üí≥ Bank Transfer Details</h4>
                                <div class="space-y-2 text-green-700">
                                    <p><strong>Bank:</strong> BPI</p>
                                    <p><strong>Account Number:</strong> 6889023641</p>
                                    <p><strong>Account Name:</strong> Ricardo Nacional III</p>
                                </div>
                            </div>
                            
                            <div class="bg-red-50 border border-red-200 rounded-lg p-6">
                                <h4 class="font-bold text-red-800 mb-3">üì∏ IMPORTANT: After Payment</h4>
                                <ol class="text-red-700 list-decimal list-inside space-y-2">
                                    <li>Take a screenshot of your bank transfer confirmation</li>
                                    <li>Join our Telegram group using the button below</li>
                                    <li>Send your transfer screenshot in the group</li>
                                    <li>Wait for admin verification and approval</li>
                                </ol>
                                <a href="https://t.me/+d_wxE9CigKA3OTA1" target="_blank" rel="noopener noreferrer" 
                                   class="inline-block bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 transition-colors mt-4 w-full text-center">
                                    üì± Join Telegram Group for Verification
                                </a>
                            </div>
                        </div>
                    `;
                    break;
                case 'PayPal':
                    instructionsHTML = `
                        <h3 class="text-2xl font-bold mb-6 text-center">üí∞ PayPal Payment Instructions</h3>
                        <div class="space-y-4">
                            <div class="bg-purple-50 border border-purple-200 rounded-lg p-6">
                                <h4 class="font-bold text-purple-800 mb-4 text-xl">üí≥ PayPal Payment Details</h4>
                                <div class="space-y-2 text-purple-700">
                                    <p><strong>PayPal Email:</strong> phantomsalonga@gmail.com</p>
                                    <p><strong>Mobile:</strong> 09606555951</p>
                                </div>
                            </div>
                            
                            <div class="bg-red-50 border border-red-200 rounded-lg p-6">
                                <h4 class="font-bold text-red-800 mb-3">üì∏ IMPORTANT: After Payment</h4>
                                <ol class="text-red-700 list-decimal list-inside space-y-2">
                                    <li>Take a screenshot of your PayPal payment confirmation</li>
                                    <li>Join our Telegram group using the button below</li>
                                    <li>Send your payment screenshot in the group</li>
                                    <li>Wait for admin verification and approval</li>
                                </ol>
                                <a href="https://t.me/+d_wxE9CigKA3OTA1" target="_blank" rel="noopener noreferrer" 
                                   class="inline-block bg-purple-500 text-white px-6 py-3 rounded-lg hover:bg-purple-600 transition-colors mt-4 w-full text-center">
                                    üì± Join Telegram Group for Verification
                                </a>
                            </div>
                        </div>
                    `;
                    break;
                default:
                    instructionsHTML = `
                        <h3 class="text-2xl font-bold mb-6 text-center">üí≥ Payment Instructions</h3>
                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-6 text-center">
                            <p class="text-gray-700">Please contact admin for payment instructions.</p>
                        </div>
                    `;
            }
            
            container.innerHTML = instructionsHTML + `
                <div class="flex gap-3 pt-6">
                    <button onclick="closePaymentModal()" class="flex-1 bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600 transition-colors">Close</button>
                </div>
            `;
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        // ===== DASHBOARD UPDATES =====
        function updateDashboard() {
            let availableCount = 0;
            let pendingCount = 0;
            let occupiedCount = 0;
            let totalRaised = 0;

            Object.keys(floorConfig).forEach(floorId => {
                const config = floorConfig[floorId];
                for (let i = 1; i <= config.slots; i++) {
                    const slotKey = `${floorId}_${i}`;
                    const investment = investments[slotKey];
                    
                    if (!investment) {
                        availableCount++;
                    } else if (investment.status === 'pending') {
                        pendingCount++;
                    } else if (investment.status === 'approved') {
                        occupiedCount++;
                        totalRaised += parseInt(investment.investmentAmount);
                    }
                }
            });

            document.getElementById('availableSlots').textContent = availableCount;
            document.getElementById('pendingSlots').textContent = pendingCount;
            document.getElementById('occupiedSlots').textContent = occupiedCount;
            document.getElementById('totalRaised').textContent = `‚Ç±${totalRaised.toLocaleString()}`;

            // Update progress bar
            const progressPercent = Math.round((totalRaised / 3000000) * 100);
            document.getElementById('progressPercent').textContent = `${progressPercent}%`;
            document.getElementById('progressBar').style.width = `${progressPercent}%`;
            document.getElementById('progressText').textContent = `‚Ç±${totalRaised.toLocaleString()} / ‚Ç±3,000,000`;
        }

        // ===== ADMIN PANEL FUNCTIONS =====
        function toggleAdminPanel() {
            const modal = document.getElementById('adminModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            document.getElementById('adminLogin').classList.remove('hidden');
            document.getElementById('adminPanel').classList.add('hidden');
            
            // Reset login form
            document.getElementById('adminUsername').value = '';
            document.getElementById('adminPassword').value = '';
            
            isAdminLoggedIn = false;
        }

        function closeAdminModal() {
            const modal = document.getElementById('adminModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            isAdminLoggedIn = false;
        }

        function adminLogin() {
            const username = document.getElementById('adminUsername').value;
            const password = document.getElementById('adminPassword').value;
            
            if (username === adminCredentials.username && password === adminCredentials.password) {
                isAdminLoggedIn = true;
                document.getElementById('adminLogin').classList.add('hidden');
                document.getElementById('adminPanel').classList.remove('hidden');
                document.getElementById('adminUsername').value = '';
                document.getElementById('adminPassword').value = '';
                showAdminTab('investments');
            } else {
                alert('Invalid credentials!');
                document.getElementById('adminUsername').value = '';
                document.getElementById('adminPassword').value = '';
            }
        }

        function showAdminTab(tabName) {
            // Hide all tabs
            document.getElementById('adminInvestmentContent').classList.add('hidden');
            document.getElementById('adminAffiliateContent').classList.add('hidden');
            document.getElementById('adminSettingsContent').classList.add('hidden');
            
            document.getElementById('adminInvestmentTab').className = 'px-4 py-2 font-semibold text-gray-500 hover:text-gray-700';
            document.getElementById('adminAffiliateTab').className = 'px-4 py-2 font-semibold text-gray-500 hover:text-gray-700';
            document.getElementById('adminSettingsTab').className = 'px-4 py-2 font-semibold text-gray-500 hover:text-gray-700';
            
            // Show selected tab
            if (tabName === 'investments') {
                document.getElementById('adminInvestmentContent').classList.remove('hidden');
                document.getElementById('adminInvestmentTab').className = 'px-4 py-2 font-semibold border-b-2 border-blue-600 text-blue-600';
                loadAdminInvestments();
            } else if (tabName === 'affiliates') {
                document.getElementById('adminAffiliateContent').classList.remove('hidden');
                document.getElementById('adminAffiliateTab').className = 'px-4 py-2 font-semibold border-b-2 border-blue-600 text-blue-600';
                loadAdminAffiliates();
            } else if (tabName === 'settings') {
                document.getElementById('adminSettingsContent').classList.remove('hidden');
                document.getElementById('adminSettingsTab').className = 'px-4 py-2 font-semibold border-b-2 border-blue-600 text-blue-600';
                loadAdminSettings();
            }
        }

        function loadAdminInvestments() {
            const container = document.getElementById('adminInvestmentContent');
            container.innerHTML = '';
            
            const pendingInvestments = Object.entries(investments).filter(([_, investment]) => 
                investment.status === 'pending'
            );
            
            const approvedInvestments = Object.entries(investments).filter(([_, investment]) => 
                investment.status === 'approved'
            );
            
            // Add approved investments management section
            if (approvedInvestments.length > 0) {
                const approvedSection = document.createElement('div');
                approvedSection.className = 'bg-green-50 p-4 rounded-lg mb-6';
                approvedSection.innerHTML = `
                    <h4 class="font-bold text-green-800 mb-4">‚úÖ Approved Investments Management</h4>
                    <div class="space-y-3">
                        ${approvedInvestments.map(([slotId, investment]) => `
                            <div class="bg-white p-4 rounded border">
                                <div class="flex justify-between items-start mb-3">
                                    <div class="flex-1">
                                        <div class="flex items-center gap-2 mb-2">
                                            <span class="font-semibold text-lg">${investment.fullName}</span>
                                            <span class="text-sm bg-blue-100 text-blue-800 px-2 py-1 rounded font-mono">${investment.slotNumber || generateSlotNumber(slotId)}</span>
                                            ${investment.affiliateNumber ? `<span class="text-xs bg-orange-100 text-orange-800 px-2 py-1 rounded">Ref: ${investment.affiliateNumber}</span>` : ''}
                                        </div>
                                        <p class="text-sm text-gray-600">${investment.floorInfo} | Investment: ‚Ç±${parseInt(investment.investmentAmount).toLocaleString()}</p>
                                        <p class="text-sm text-gray-600">Email: ${investment.email} | Mobile: ${investment.mobile}</p>
                                        <p class="text-sm text-gray-600">Dividend Method: ${investment.dividendMode} | Account: ${investment.accountDetails}</p>
                                        <p class="text-xs text-gray-400">Approved: ${new Date(investment.timestamp).toLocaleDateString()}</p>
                                    </div>
                                    ${investment.photo ? `<img src="${investment.photo}" alt="Photo" class="w-16 h-16 object-cover rounded ml-4">` : ''}
                                </div>
                                
                                <div class="grid md:grid-cols-2 gap-4 mt-4 pt-4 border-t">
                                    <div class="space-y-3">
                                        <div class="flex items-center gap-2">
                                            <span class="text-sm font-medium w-20">Dividend: ‚Ç±</span>
                                            <input type="number" id="dividend_${slotId}" value="${investment.dividendEarned || 0}" 
                                                   class="w-24 p-2 border rounded text-sm" min="0" step="100">
                                            <button onclick="updateDividend('${slotId}')" 
                                                    class="bg-blue-600 text-white px-3 py-2 rounded text-sm hover:bg-blue-700">Update</button>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <span class="text-sm font-medium w-20">Withdrawn: ‚Ç±</span>
                                            <input type="number" id="withdrawal_${slotId}" value="${investment.dividendWithdrawn || 0}" 
                                                   class="w-24 p-2 border rounded text-sm" min="0" step="100">
                                            <button onclick="updateDividendWithdrawn('${slotId}')" 
                                                    class="bg-orange-600 text-white px-3 py-2 rounded text-sm hover:bg-orange-700">Update</button>
                                        </div>
                                    </div>
                                    <div class="flex flex-col justify-center space-y-2">
                                        <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-4 text-center mb-2">
                                            <div class="text-blue-800 font-bold mb-2">üîê PASSWORD MANAGEMENT</div>
                                            <div class="text-xs text-blue-600 mb-2">Current Password: <strong>${investment.portfolioPassword}</strong></div>
                                            <div class="flex items-center gap-2 mb-2">
                                                <input type="password" id="newPassword_${slotId}" placeholder="New password" 
                                                       class="flex-1 p-2 border rounded text-sm" minlength="6">
                                                <button onclick="resetInvestorPassword('${slotId}')" 
                                                        class="bg-blue-600 text-white px-3 py-2 rounded text-sm hover:bg-blue-700">
                                                    üîÑ Reset
                                                </button>
                                            </div>
                                        </div>
                                        <div class="bg-red-50 border-2 border-red-200 rounded-lg p-4 text-center">
                                            <div class="text-red-800 font-bold mb-2">‚ö†Ô∏è DANGER ZONE</div>
                                            <button onclick="confirmRevokeInvestment('${slotId}')" 
                                                    class="bg-red-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-red-700 font-bold w-full border-2 border-red-700 shadow-lg transform hover:scale-105 transition-all mb-2">
                                                üö´ REVOKE INVESTMENT
                                            </button>
                                            <button onclick="confirmDeleteInvestor('${slotId}')" 
                                                    class="bg-red-800 text-white px-4 py-2 rounded-lg text-sm hover:bg-red-900 font-bold w-full border-2 border-red-900 shadow-lg transform hover:scale-105 transition-all">
                                                üóëÔ∏è DELETE INVESTOR
                                            </button>
                                            <div class="text-xs text-red-600 mt-1">Revoke = slot available | Delete = permanent removal</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="text-xs text-gray-500 mt-2">
                                    Available for withdrawal: ‚Ç±${((investment.dividendEarned || 0) - (investment.dividendWithdrawn || 0)).toLocaleString()} | 
                                    Total withdrawn: ‚Ç±${(investment.dividendWithdrawn || 0).toLocaleString()}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                container.appendChild(approvedSection);
            }
            
            // Add pending investments section
            if (pendingInvestments.length === 0) {
                const noPendingDiv = document.createElement('div');
                noPendingDiv.className = 'bg-yellow-50 p-4 rounded-lg';
                noPendingDiv.innerHTML = '<p class="text-center text-yellow-700">‚úÖ No pending investments to review</p>';
                container.appendChild(noPendingDiv);
            } else {
                const pendingSection = document.createElement('div');
                pendingSection.className = 'bg-yellow-50 p-4 rounded-lg';
                pendingSection.innerHTML = `
                    <h4 class="font-bold text-yellow-800 mb-4">‚è≥ Pending Investments (${pendingInvestments.length})</h4>
                    <div class="space-y-4">
                        ${pendingInvestments.map(([slotId, investment]) => `
                            <div class="bg-white p-4 rounded-lg border-l-4 border-yellow-400">
                                <div class="flex justify-between items-start mb-3">
                                    <div class="flex-1">
                                        <div class="flex items-center gap-2 mb-2">
                                            <span class="font-semibold text-lg">${investment.fullName}</span>
                                            <span class="text-sm bg-blue-100 text-blue-800 px-2 py-1 rounded font-mono">${investment.slotNumber || generateSlotNumber(slotId)}</span>
                                            ${investment.affiliateNumber ? `<span class="text-xs bg-orange-100 text-orange-800 px-2 py-1 rounded">Affiliate: ${investment.affiliateNumber}</span>` : ''}
                                        </div>
                                        <p class="text-sm text-gray-600">${investment.floorInfo} | Investment: ‚Ç±${parseInt(investment.investmentAmount).toLocaleString()}</p>
                                        <p class="text-sm text-gray-600">Email: ${investment.email} | Mobile: ${investment.mobile}</p>
                                        <p class="text-sm text-gray-600">Payment: ${investment.paymentMode} | Dividend: ${investment.dividendMode}</p>
                                        <p class="text-sm text-gray-600">Account Details: ${investment.accountDetails}</p>
                                        ${investment.customText ? `<p class="text-sm text-gray-600">Display Text: "${investment.customText}"</p>` : ''}
                                        <p class="text-xs text-gray-400">Submitted: ${new Date(investment.timestamp).toLocaleDateString()}</p>
                                        ${investment.affiliateNumber ? `
                                            <div class="mt-2 p-2 bg-orange-50 rounded text-sm">
                                                <strong class="text-orange-800">Affiliate Commission:</strong> 
                                                <span class="text-green-600">‚Ç±${Math.round(parseInt(investment.investmentAmount) * 0.05).toLocaleString()}</span>
                                                <span class="text-gray-600">(5% of ‚Ç±${parseInt(investment.investmentAmount).toLocaleString()})</span>
                                            </div>
                                        ` : ''}
                                    </div>
                                    ${investment.photo ? `<img src="${investment.photo}" alt="Photo" class="w-20 h-20 object-cover rounded ml-4">` : ''}
                                </div>
                                
                                <div class="flex gap-3 pt-3 border-t">
                                    <button onclick="approveInvestment('${slotId}')" 
                                            class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700 flex-1 font-semibold">
                                        ‚úÖ APPROVE & Process Commission
                                    </button>
                                    <button onclick="disapproveInvestment('${slotId}')" 
                                            class="bg-red-600 text-white px-6 py-2 rounded hover:bg-red-700 flex-1 font-semibold">
                                        ‚ùå DISAPPROVE & Remove
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                container.appendChild(pendingSection);
            }
        }

        function loadAdminAffiliates() {
            const container = document.getElementById('adminAffiliateContent');
            const affiliateList = Object.entries(affiliates);
            
            container.innerHTML = `
                <div class="mb-6">
                    <h4 class="text-lg font-bold mb-4">üíº Affiliate Management Dashboard</h4>
                    <div class="grid md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-green-800">${affiliateList.length}</div>
                            <div class="text-sm text-green-600">Total Affiliates</div>
                        </div>
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-blue-800">${affiliateList.reduce((sum, [_, aff]) => sum + (aff.totalReferrals || 0), 0)}</div>
                            <div class="text-sm text-blue-600">Total Referrals</div>
                        </div>
                        <div class="bg-orange-50 border border-orange-200 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-orange-800">‚Ç±${affiliateList.reduce((sum, [_, aff]) => sum + (aff.totalCommissions || 0), 0).toLocaleString()}</div>
                            <div class="text-sm text-orange-600">Total Commissions</div>
                        </div>
                        <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-purple-800">‚Ç±${affiliateList.reduce((sum, [_, aff]) => sum + (aff.totalWithdrawals || 0), 0).toLocaleString()}</div>
                            <div class="text-sm text-purple-600">Total Withdrawals</div>
                        </div>
                    </div>
                </div>
                <div class="space-y-4">
                    ${affiliateList.length === 0 ? '<p class="text-center text-gray-500">No affiliates registered</p>' : 
                        affiliateList.map(([email, affiliate], index) => {
                            const safeId = email.replace(/[@.]/g, '_');
                            return `
                            <div class="bg-white p-4 rounded-lg border">
                                <div class="flex justify-between items-start mb-4">
                                    <div class="flex-1">
                                        <div class="flex items-center gap-2 mb-2">
                                            <h4 class="font-bold text-lg">${affiliate.name}</h4>
                                            <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded font-mono">${affiliate.affiliateNumber}</span>
                                        </div>
                                        <p class="text-sm text-gray-600">üìß ${email}</p>
                                        <p class="text-sm text-gray-600">üì± ${affiliate.mobile}</p>
                                        <p class="text-sm text-gray-600">üí≥ ${affiliate.paymentMethod}</p>
                                        <p class="text-xs text-gray-400">Registered: ${new Date(affiliate.registrationDate).toLocaleDateString()}</p>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-lg font-bold text-green-600">‚Ç±${(affiliate.totalCommissions || 0).toLocaleString()}</div>
                                        <div class="text-sm text-gray-500">Available Balance</div>
                                        <div class="text-sm text-blue-600">${(affiliate.totalReferrals || 0)} Referrals</div>
                                        ${affiliate.pendingCommissions > 0 ? `<div class="text-sm text-orange-600">‚Ç±${affiliate.pendingCommissions.toLocaleString()} Pending</div>` : ''}
                                        ${affiliate.totalWithdrawals > 0 ? `<div class="text-sm text-purple-600">‚Ç±${(affiliate.totalWithdrawals || 0).toLocaleString()} Withdrawn</div>` : ''}
                                    </div>
                                </div>
                                
                                ${affiliate.referrals && affiliate.referrals.length > 0 ? `
                                    <div class="mb-4 p-3 bg-gray-50 rounded">
                                        <h5 class="font-semibold mb-2 text-gray-700">üìä Recent Referrals:</h5>
                                        <div class="space-y-2">
                                            ${affiliate.referrals.slice(-3).map(ref => `
                                                <div class="text-sm bg-white p-2 rounded border-l-4 ${ref.status === 'approved' ? 'border-green-400' : 'border-orange-400'}">
                                                    <div class="flex justify-between items-center">
                                                        <div>
                                                            <span class="font-medium">${ref.investorName}</span>
                                                            <span class="text-gray-600">- ‚Ç±${ref.investmentAmount.toLocaleString()}</span>
                                                        </div>
                                                        <div class="text-right">
                                                            <span class="text-green-600 font-semibold">‚Ç±${ref.commission.toLocaleString()}</span>
                                                            <span class="text-xs ${ref.status === 'approved' ? 'text-green-600' : 'text-orange-600'} ml-2">${ref.status}</span>
                                                        </div>
                                                    </div>
                                                    <div class="text-xs text-gray-400 mt-1">${new Date(ref.date).toLocaleDateString()}</div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                                
                                <div class="grid md:grid-cols-2 gap-4 p-3 bg-blue-50 rounded mb-4">
                                    <div>
                                        <h5 class="font-semibold mb-2 text-blue-800">üí∞ Balance Management:</h5>
                                        <div class="space-y-2">
                                            <div class="flex items-center gap-2">
                                                <span class="text-sm w-20">Available:</span>
                                                <input type="number" id="totalEarned_${safeId}" value="${affiliate.totalCommissions || 0}" 
                                                       class="w-24 p-1 border rounded text-sm" min="0" step="100">
                                                <button onclick="updateAffiliateEarnings('${email}')" 
                                                        class="bg-blue-600 text-white px-2 py-1 rounded text-xs hover:bg-blue-700">Update</button>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <span class="text-sm w-20">Pending:</span>
                                                <input type="number" id="pendingEarned_${safeId}" value="${affiliate.pendingCommissions || 0}" 
                                                       class="w-24 p-1 border rounded text-sm" min="0" step="100">
                                                <button onclick="updateAffiliatePending('${email}')" 
                                                        class="bg-orange-600 text-white px-2 py-1 rounded text-xs hover:bg-orange-700">Update</button>
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <h5 class="font-semibold mb-2 text-red-800">üí∏ Update Withdrawn:</h5>
                                        <div class="space-y-2">
                                            <div class="flex items-center gap-2">
                                                <span class="text-sm w-20">Withdrawn:</span>
                                                <input type="number" id="withdrawal_${safeId}" value="${affiliate.totalWithdrawals || 0}" 
                                                       class="w-24 p-1 border rounded text-sm" min="0" step="100">
                                                <button onclick="updateWithdrawn('${email}')" 
                                                        class="bg-red-600 text-white px-2 py-1 rounded text-xs hover:bg-red-700">Update</button>
                                            </div>
                                            <div class="text-xs text-gray-600">Total Withdrawn: ‚Ç±${(affiliate.totalWithdrawals || 0).toLocaleString()}</div>
                                        </div>
                                    </div>
                                </div>
                                
                                ${affiliate.withdrawalHistory && affiliate.withdrawalHistory.length > 0 ? `
                                    <div class="mb-4 p-3 bg-purple-50 rounded">
                                        <h5 class="font-semibold mb-2 text-purple-800">üí≥ Withdrawal History:</h5>
                                        <div class="space-y-1">
                                            ${affiliate.withdrawalHistory.slice(-3).map(withdrawal => `
                                                <div class="text-sm bg-white p-2 rounded flex justify-between items-center">
                                                    <span>‚Ç±${withdrawal.amount.toLocaleString()}</span>
                                                    <span class="text-xs text-gray-500">${new Date(withdrawal.date).toLocaleDateString()}</span>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                                
                                <div class="flex gap-2 pt-3 border-t">
                                    <button onclick="approveAffiliateCommissions('${email}')" 
                                            class="bg-green-600 text-white px-3 py-2 rounded text-sm hover:bg-green-700 flex-1">
                                        ‚úÖ Approve All Pending
                                    </button>
                                    <button onclick="viewAffiliateDetails('${email}')" 
                                            class="bg-blue-600 text-white px-3 py-2 rounded text-sm hover:bg-blue-700 flex-1">
                                        üìä View Full Details
                                    </button>
                                    <button onclick="confirmDeleteAffiliate('${email}')" 
                                            class="bg-red-600 text-white px-3 py-2 rounded text-sm hover:bg-red-700 flex-1">
                                        üóëÔ∏è Delete Affiliate
                                    </button>
                                </div>
                            </div>
                        `;
                        }).join('')
                    }
                </div>
            `;
        }

        async function approveAffiliateCommissions(email) {
            const affiliate = affiliates[email];
            if (affiliate && affiliate.pendingCommissions > 0) {
                affiliate.totalCommissions = (affiliate.totalCommissions || 0) + affiliate.pendingCommissions;
                affiliate.pendingCommissions = 0;
                
                // Update referral statuses
                if (affiliate.referrals) {
                    affiliate.referrals.forEach(ref => {
                        if (ref.status === 'pending') {
                            ref.status = 'approved';
                        }
                    });
                }
                
                await saveData('affiliates', affiliates);
                loadAdminAffiliates();
                alert(`Commissions approved for ${affiliate.name}`);
            }
        }

        async function updateDividend(slotId) {
            const dividendInput = document.getElementById(`dividend_${slotId}`);
            const dividendAmount = parseFloat(dividendInput.value) || 0;
            
            if (investments[slotId]) {
                investments[slotId].dividendEarned = dividendAmount;
                await saveData('investments', investments);
                alert(`Dividend updated to ‚Ç±${dividendAmount.toLocaleString()} for ${investments[slotId].fullName}`);
                loadAdminInvestments(); // Refresh the display
            }
        }

        async function updateDividendWithdrawn(slotId) {
            const withdrawalInput = document.getElementById(`withdrawal_${slotId}`);
            if (!withdrawalInput) {
                alert('Error: Withdrawal input field not found!');
                return;
            }
            
            const withdrawnAmount = parseFloat(withdrawalInput.value) || 0;
            const investment = investments[slotId];
            
            if (!investment) {
                alert('Investment not found!');
                return;
            }
            
            if (withdrawnAmount < 0) {
                alert('Withdrawn amount cannot be negative!');
                return;
            }
            
            // Update the withdrawn amount
            investment.dividendWithdrawn = withdrawnAmount;
            
            // Save changes
            await saveData('investments', investments);
            
            // Reload the admin panel
            loadAdminInvestments();
            
            alert(`‚úÖ Dividend withdrawn amount updated!\n\nInvestor: ${investment.fullName}\nTotal Withdrawn: ‚Ç±${withdrawnAmount.toLocaleString()}\nAvailable Balance: ‚Ç±${((investment.dividendEarned || 0) - withdrawnAmount).toLocaleString()}`);
        }

        async function resetInvestorPassword(slotId) {
            const newPasswordInput = document.getElementById(`newPassword_${slotId}`);
            if (!newPasswordInput) {
                alert('Error: Password input field not found!');
                return;
            }
            
            const newPassword = newPasswordInput.value.trim();
            const investment = investments[slotId];
            
            if (!investment) {
                alert('Investment not found!');
                return;
            }
            
            if (!newPassword) {
                alert('Please enter a new password!');
                return;
            }
            
            if (newPassword.length < 6) {
                alert('Password must be at least 6 characters long!');
                return;
            }
            
            const oldPassword = investment.portfolioPassword;
            
            // Update the password
            investment.portfolioPassword = newPassword;
            
            // Save changes to Firebase
            try {
                await saveData('investments', investments);
                updateConnectionStatus('online', 'Password updated successfully');
            } catch (error) {
                console.error('Failed to save password update to Firebase:', error);
                updateConnectionStatus('offline', 'Password updated locally only');
                alert('‚ö†Ô∏è Password updated but failed to save to Firebase. Changes may not persist.');
            }
            
            // Clear the input field
            newPasswordInput.value = '';
            
            // Reload the admin panel to show the new password
            loadAdminInvestments();
            
            alert(`‚úÖ Password Reset Successful!\n\nInvestor: ${investment.fullName}\nEmail: ${investment.email}\n\nOld Password: ${oldPassword}\nNew Password: ${newPassword}\n\nThe investor can now use the new password to access their portfolio.`);
        }

        async function approveInvestment(slotId) {
            const investment = investments[slotId];
            investment.status = 'approved';
            investment.dividendEarned = 0; // Initialize dividend earned
            
            // Process affiliate commission if applicable
            if (investment.affiliateNumber) {
                const affiliate = Object.values(affiliates).find(aff => aff.affiliateNumber === investment.affiliateNumber);
                if (affiliate) {
                    // Update referral status to approved and add to total commissions
                    const referral = affiliate.referrals.find(ref => ref.slotId === slotId);
                    if (referral) {
                        referral.status = 'approved';
                        affiliate.totalReferrals = (affiliate.totalReferrals || 0) + 1;
                        
                        // Move commission from pending to total
                        affiliate.totalCommissions = (affiliate.totalCommissions || 0) + referral.commission;
                        affiliate.pendingCommissions = (affiliate.pendingCommissions || 0) - referral.commission;
                        
                        // Update affiliate data
                        const affiliateEmail = Object.keys(affiliates).find(email => affiliates[email].affiliateNumber === investment.affiliateNumber);
                        if (affiliateEmail) {
                            affiliates[affiliateEmail] = affiliate;
                            await saveData('affiliates', affiliates);
                        }
                    }
                }
            }
            
            // Save to Firebase
            try {
                await saveData('investments', investments);
                updateConnectionStatus('online', 'Investment approved and saved');
            } catch (error) {
                console.error('Failed to save approved investment to Firebase:', error);
                updateConnectionStatus('offline', 'Approval saved locally only');
                alert('‚ö†Ô∏è Investment approved but failed to save to Firebase. Changes may not persist.');
            }
            
            const slot = document.querySelector(`[data-slot-id="${slotId}"]`);
            updateSlotAppearance(slot, slotId);
            
            loadAdminInvestments();
            updateDashboard();
            alert('Investment approved successfully! Affiliate commission processed.');
        }

        async function disapproveInvestment(slotId) {
            const investment = investments[slotId];
            
            // Remove affiliate referral if applicable
            if (investment.affiliateNumber) {
                const affiliate = Object.values(affiliates).find(aff => aff.affiliateNumber === investment.affiliateNumber);
                if (affiliate) {
                    // Remove referral and adjust pending commissions
                    const referralIndex = affiliate.referrals.findIndex(ref => ref.slotId === slotId);
                    if (referralIndex !== -1) {
                        const referral = affiliate.referrals[referralIndex];
                        affiliate.pendingCommissions = (affiliate.pendingCommissions || 0) - referral.commission;
                        affiliate.referrals.splice(referralIndex, 1);
                        
                        // Update affiliate data
                        const affiliateEmail = Object.keys(affiliates).find(email => affiliates[email].affiliateNumber === investment.affiliateNumber);
                        if (affiliateEmail) {
                            affiliates[affiliateEmail] = affiliate;
                            await saveData('affiliates', affiliates);
                        }
                    }
                }
            }
            
            delete investments[slotId];
            await saveData('investments', investments);
            
            const slot = document.querySelector(`[data-slot-id="${slotId}"]`);
            updateSlotAppearance(slot, slotId);
            
            loadAdminInvestments();
            updateDashboard();
            alert('Investment disapproved and removed.');
        }

        function confirmRevokeInvestment(slotId) {
            const investment = investments[slotId];
            if (!investment) {
                alert('Investment not found!');
                return;
            }
            
            const confirmMessage = `‚ö†Ô∏è CONFIRM REVOKE INVESTMENT ‚ö†Ô∏è\n\n` +
                `Investor: ${investment.fullName}\n` +
                `Slot: ${slotId}\n` +
                `Investment Amount: ‚Ç±${parseInt(investment.investmentAmount).toLocaleString()}\n` +
                `Dividend Earned: ‚Ç±${(investment.dividendEarned || 0).toLocaleString()}\n\n` +
                `This action will:\n` +
                `‚Ä¢ Make the slot available (green) again\n` +
                `‚Ä¢ Remove all investment data permanently\n` +
                `‚Ä¢ Reverse any affiliate commissions\n` +
                `‚Ä¢ Cannot be undone\n\n` +
                `Type "REVOKE" to confirm:`;
            
            const userInput = prompt(confirmMessage);
            
            if (userInput === 'REVOKE') {
                revokeInvestment(slotId);
            } else {
                alert('Revoke cancelled. Investment remains unchanged.');
            }
        }

        async function revokeInvestment(slotId) {
            const investment = investments[slotId];
            
            if (!investment) {
                alert('Investment not found!');
                return;
            }
            
            console.log('Revoking investment for slot:', slotId);
            console.log('Investment data:', investment);
            
            // Handle affiliate commission reversal if applicable
            if (investment.affiliateNumber) {
                console.log('Processing affiliate reversal for:', investment.affiliateNumber);
                
                // Find affiliate by affiliate number
                let affiliateEmail = null;
                let affiliate = null;
                
                for (const [email, affData] of Object.entries(affiliates)) {
                    if (affData.affiliateNumber === investment.affiliateNumber) {
                        affiliateEmail = email;
                        affiliate = affData;
                        break;
                    }
                }
                
                if (affiliate && affiliateEmail) {
                    console.log('Found affiliate:', affiliate.name, 'Email:', affiliateEmail);
                    
                    // Find and remove the referral
                    if (affiliate.referrals) {
                        const referralIndex = affiliate.referrals.findIndex(ref => ref.slotId === slotId);
                        if (referralIndex !== -1) {
                            const referral = affiliate.referrals[referralIndex];
                            console.log('Removing referral:', referral);
                            
                            // Deduct commission from total earnings
                            affiliate.totalCommissions = Math.max(0, (affiliate.totalCommissions || 0) - referral.commission);
                            affiliate.totalReferrals = Math.max(0, (affiliate.totalReferrals || 0) - 1);
                            
                            // Remove the referral completely
                            affiliate.referrals.splice(referralIndex, 1);
                            
                            console.log('Updated affiliate totals:', {
                                totalCommissions: affiliate.totalCommissions,
                                totalReferrals: affiliate.totalReferrals
                            });
                        }
                    }
                    
                    // Update affiliate data in storage
                    affiliates[affiliateEmail] = affiliate;
                    await saveData('affiliates', affiliates);
                    console.log('Affiliate data updated in storage');
                }
            }
            
            // Remove the investment completely from storage
            delete investments[slotId];
            await saveData('investments', investments);
            console.log('Investment removed from storage');
            
            // Find the slot element and completely reset it
            const slot = document.querySelector(`[data-slot-id="${slotId}"]`);
            if (slot) {
                console.log('Resetting slot element:', slot);
                
                // Get the base classes for investment slots
                const baseClasses = 'investment-slot w-12 h-12 rounded-lg flex items-center justify-center text-white font-bold text-xs';
                
                // Reset to available state with proper classes
                slot.className = baseClasses + ' available';
                slot.textContent = '';
                slot.style.backgroundImage = '';
                slot.style.backgroundSize = '';
                slot.style.backgroundPosition = '';
                slot.style.backgroundColor = '';
                
                console.log('Slot reset complete. New className:', slot.className);
            } else {
                console.log('Slot element not found for:', slotId);
            }
            
            // Close photo modal if it's open for this slot
            if (currentPhotoSlot === slotId) {
                closePhotoModal();
            }
            
            // Force refresh of all displays
            setTimeout(() => {
                updateDashboard();
                if (isAdminLoggedIn) {
                    loadAdminInvestments();
                    loadAdminAffiliates();
                }
            }, 100);
            
            alert(`‚úÖ Investment revoked successfully!\n\nSlot ${slotId} is now available (green) again.\nAll investment and affiliate data has been removed.`);
        }

        async function updateAffiliateEarnings(email) {
            const safeId = email.replace(/[@.]/g, '_');
            const newAmount = parseFloat(document.getElementById(`totalEarned_${safeId}`).value) || 0;
            if (affiliates[email]) {
                affiliates[email].totalCommissions = newAmount;
                await saveData('affiliates', affiliates);
                alert(`Total earnings updated to ‚Ç±${newAmount.toLocaleString()} for ${affiliates[email].name}`);
                loadAdminAffiliates();
            }
        }

        async function updateAffiliatePending(email) {
            const safeId = email.replace(/[@.]/g, '_');
            const newAmount = parseFloat(document.getElementById(`pendingEarned_${safeId}`).value) || 0;
            if (affiliates[email]) {
                affiliates[email].pendingCommissions = newAmount;
                await saveData('affiliates', affiliates);
                alert(`Pending earnings updated to ‚Ç±${newAmount.toLocaleString()} for ${affiliates[email].name}`);
                loadAdminAffiliates();
            }
        }

        async function updateWithdrawn(email) {
            // Clean email for ID generation
            const safeId = email.replace(/[@.]/g, '_');
            const withdrawalInput = document.getElementById(`withdrawal_${safeId}`);
            
            if (!withdrawalInput) {
                alert('Error: Withdrawal input field not found!');
                return;
            }
            
            const withdrawnAmount = parseFloat(withdrawalInput.value) || 0;
            const affiliate = affiliates[email];
            
            if (!affiliate) {
                alert('Affiliate not found!');
                return;
            }
            
            if (withdrawnAmount < 0) {
                alert('Withdrawn amount cannot be negative!');
                return;
            }
            
            // Update the withdrawn amount
            affiliate.totalWithdrawals = withdrawnAmount;
            
            // Save changes
            await saveData('affiliates', affiliates);
            
            // Reload the affiliate panel
            loadAdminAffiliates();
            
            alert(`‚úÖ Withdrawn amount updated!\n\nAffiliate: ${affiliate.name}\nTotal Withdrawn: ‚Ç±${withdrawnAmount.toLocaleString()}`);
        }

        function viewAffiliateDetails(email) {
            const affiliate = affiliates[email];
            if (!affiliate) return;
            
            const totalEarned = (affiliate.totalCommissions || 0) + (affiliate.totalWithdrawals || 0);
            const referralsList = affiliate.referrals ? affiliate.referrals.map(ref => 
                `‚Ä¢ ${ref.investorName} - ‚Ç±${ref.investmentAmount.toLocaleString()} (‚Ç±${ref.commission.toLocaleString()} commission) - ${ref.status} - ${new Date(ref.date).toLocaleDateString()}`
            ).join('\n') : 'No referrals yet';
            
            const withdrawalsList = affiliate.withdrawalHistory ? affiliate.withdrawalHistory.map(w => 
                `‚Ä¢ ‚Ç±${w.amount.toLocaleString()} - ${new Date(w.date).toLocaleDateString()}`
            ).join('\n') : 'No withdrawals yet';
            
            alert(`üìä AFFILIATE DETAILS\n\n` +
                `Name: ${affiliate.name}\n` +
                `Email: ${email}\n` +
                `Mobile: ${affiliate.mobile}\n` +
                `Affiliate #: ${affiliate.affiliateNumber}\n` +
                `Payment Method: ${affiliate.paymentMethod}\n` +
                `Registered: ${new Date(affiliate.registrationDate).toLocaleDateString()}\n\n` +
                
                `üí∞ FINANCIAL SUMMARY\n` +
                `Available Balance: ‚Ç±${(affiliate.totalCommissions || 0).toLocaleString()}\n` +
                `Pending Commissions: ‚Ç±${(affiliate.pendingCommissions || 0).toLocaleString()}\n` +
                `Total Withdrawn: ‚Ç±${(affiliate.totalWithdrawals || 0).toLocaleString()}\n` +
                `Lifetime Earnings: ‚Ç±${totalEarned.toLocaleString()}\n` +
                `Total Referrals: ${affiliate.totalReferrals || 0}\n\n` +
                
                `üìã RECENT REFERRALS\n${referralsList}\n\n` +
                `üí≥ WITHDRAWAL HISTORY\n${withdrawalsList}`
            );
        }

        function showPaymentModal() {
            const modal = document.getElementById('paymentModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closePaymentModal() {
            const modal = document.getElementById('paymentModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        // ===== PORTFOLIO FUNCTIONS =====
        function showPortfolioDashboard() {
            const modal = document.getElementById('portfolioModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            // Reset to login view
            document.getElementById('portfolioLogin').classList.remove('hidden');
            document.getElementById('portfolioContent').classList.add('hidden');
            document.getElementById('portfolioEmail').value = '';
            document.getElementById('portfolioPasswordLogin').value = '';
        }

        function closePortfolioModal() {
            const modal = document.getElementById('portfolioModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        function loadPortfolio() {
            const email = document.getElementById('portfolioEmail').value.trim();
            const password = document.getElementById('portfolioPasswordLogin').value.trim();
            
            if (!email || !password) {
                alert('Please enter both your email address and portfolio password');
                return;
            }
            
            // Find investments for this email
            const userInvestments = Object.entries(investments).filter(([_, investment]) => 
                investment.email.toLowerCase() === email.toLowerCase() && investment.status === 'approved'
            );
            
            if (userInvestments.length === 0) {
                alert('No approved investments found for this email address');
                return;
            }
            
            // Verify password with any of the user's investments
            const passwordMatch = userInvestments.some(([_, investment]) => 
                investment.portfolioPassword === password
            );
            
            if (!passwordMatch) {
                alert('Incorrect portfolio password. Please check your password and try again.');
                return;
            }
            
            // Calculate totals
            let totalInvested = 0;
            let totalDividendEarned = 0;
            let totalDividendWithdrawn = 0;
            
            userInvestments.forEach(([_, investment]) => {
                totalInvested += parseInt(investment.investmentAmount);
                totalDividendEarned += (investment.dividendEarned || 0);
                totalDividendWithdrawn += (investment.dividendWithdrawn || 0);
            });
            
            // Update summary
            document.getElementById('totalInvested').textContent = `‚Ç±${totalInvested.toLocaleString()}`;
            document.getElementById('dividendEarned').textContent = `‚Ç±${totalDividendEarned.toLocaleString()}`;
            document.getElementById('dividendWithdrawn').textContent = `‚Ç±${totalDividendWithdrawn.toLocaleString()}`;
            document.getElementById('totalSlots').textContent = userInvestments.length;
            
            // Load investment details
            const container = document.getElementById('portfolioInvestments');
            container.innerHTML = `
                <h4 class="text-lg font-bold mb-4">üìã Your Investment Units</h4>
                <div class="space-y-4">
                    ${userInvestments.map(([slotId, investment]) => `
                        <div class="bg-white border rounded-lg p-4">
                            <div class="flex justify-between items-start mb-3">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="font-semibold text-lg font-mono">${investment.slotNumber || generateSlotNumber(slotId)}</span>
                                        <span class="text-sm bg-blue-100 text-blue-800 px-2 py-1 rounded">${investment.floorInfo}</span>
                                    </div>
                                    <p class="text-sm text-gray-600">Investment: ‚Ç±${parseInt(investment.investmentAmount).toLocaleString()}</p>
                                    <p class="text-sm text-gray-600">Dividend Earned: ‚Ç±${(investment.dividendEarned || 0).toLocaleString()}</p>
                                    <p class="text-sm text-gray-600">Dividend Withdrawn: ‚Ç±${(investment.dividendWithdrawn || 0).toLocaleString()}</p>
                                    <p class="text-sm text-green-600 font-semibold">Available Balance: ‚Ç±${((investment.dividendEarned || 0) - (investment.dividendWithdrawn || 0)).toLocaleString()}</p>
                                    <p class="text-xs text-gray-400">Invested: ${new Date(investment.timestamp).toLocaleDateString()}</p>
                                </div>
                                ${investment.photo ? `<img src="${investment.photo}" alt="Your Photo" class="w-16 h-16 object-cover rounded ml-4">` : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            // Show portfolio content
            document.getElementById('portfolioLogin').classList.add('hidden');
            document.getElementById('portfolioContent').classList.remove('hidden');
        }

        // ===== BUDGET RECOMMENDATION FUNCTIONS =====
        let selectedBudget = 0;
        let recommendedSlots = [];

        function showBudgetRecommendation() {
            const modal = document.getElementById('budgetModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            // Reset state
            selectedBudget = 0;
            recommendedSlots = [];
            document.getElementById('budgetRecommendation').classList.add('hidden');
            document.getElementById('investNowBtn').classList.add('hidden');
            document.getElementById('customBudget').value = '';
            
            // Reset budget button styles
            document.querySelectorAll('.budget-btn').forEach(btn => {
                btn.className = 'budget-btn bg-gray-100 hover:bg-purple-100 border-2 border-gray-300 hover:border-purple-500 p-3 rounded-lg text-center transition-all';
            });
        }

        function closeBudgetModal() {
            const modal = document.getElementById('budgetModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        function setBudget(budget) {
            selectedBudget = parseInt(budget);
            
            if (selectedBudget < 500) {
                alert('Minimum investment amount is ‚Ç±500');
                return;
            }
            
            // Update custom input if budget was set via button
            if (document.getElementById('customBudget').value != budget) {
                document.getElementById('customBudget').value = budget;
            }
            
            // Update button styles
            document.querySelectorAll('.budget-btn').forEach(btn => {
                btn.className = 'budget-btn bg-gray-100 hover:bg-purple-100 border-2 border-gray-300 hover:border-purple-500 p-3 rounded-lg text-center transition-all';
            });
            
            // Highlight selected budget button
            const selectedBtn = document.querySelector(`button[onclick="setBudget(${budget})"]`);
            if (selectedBtn) {
                selectedBtn.className = 'budget-btn bg-purple-200 border-2 border-purple-600 p-3 rounded-lg text-center transition-all';
            }
            
            generateRecommendation(selectedBudget);
        }

        function generateRecommendation(budget) {
            // Find matching floor configurations
            const matchingFloors = [];
            const availableSlots = [];
            
            Object.entries(floorConfig).forEach(([floorId, config]) => {
                if (config.price <= budget) {
                    matchingFloors.push({
                        floorId,
                        ...config,
                        availableCount: 0
                    });
                }
            });
            
            // Sort by price (highest first for best value)
            matchingFloors.sort((a, b) => b.price - a.price);
            
            // Count available slots for each matching floor
            matchingFloors.forEach(floor => {
                for (let i = 1; i <= floor.slots; i++) {
                    const slotKey = `${floor.floorId}_${i}`;
                    if (!investments[slotKey]) {
                        floor.availableCount++;
                        availableSlots.push({
                            slotId: slotKey,
                            floorId: floor.floorId,
                            floorName: floor.name,
                            price: floor.price,
                            icon: floor.icon
                        });
                    }
                }
            });
            
            displayRecommendation(budget, matchingFloors, availableSlots);
        }

        function displayRecommendation(budget, matchingFloors, availableSlots) {
            const container = document.getElementById('budgetRecommendation');
            
            if (matchingFloors.length === 0) {
                container.innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-6 text-center">
                        <div class="text-red-800 text-xl font-bold mb-2">‚ùå No Investment Options Found</div>
                        <p class="text-red-700">Your budget of ‚Ç±${budget.toLocaleString()} is below our minimum investment of ‚Ç±500.</p>
                        <p class="text-red-600 text-sm mt-2">Please increase your budget to at least ‚Ç±500 to see available options.</p>
                    </div>
                `;
                container.classList.remove('hidden');
                return;
            }
            
            const bestOption = matchingFloors[0];
            const totalAvailable = availableSlots.filter(slot => slot.price <= budget).length;
            
            container.innerHTML = `
                <div class="space-y-6">
                    <div class="bg-green-50 border border-green-200 rounded-lg p-6">
                        <div class="text-center mb-4">
                            <div class="text-green-800 text-2xl font-bold mb-2">üéØ Perfect Match Found!</div>
                            <p class="text-green-700">Based on your budget of <strong>‚Ç±${budget.toLocaleString()}</strong>, here are your investment options:</p>
                        </div>
                        
                        <div class="bg-white rounded-lg p-4 border-2 border-green-300 mb-4">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center gap-3">
                                    <span class="text-3xl">${bestOption.icon}</span>
                                    <div>
                                        <div class="text-xl font-bold text-green-800">RECOMMENDED: ${bestOption.name} Floor</div>
                                        <div class="text-green-600">Best value for your budget!</div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-2xl font-bold text-green-800">‚Ç±${bestOption.price.toLocaleString()}</div>
                                    <div class="text-sm text-green-600">${bestOption.availableCount} units available</div>
                                </div>
                            </div>
                            
                            <div class="grid md:grid-cols-2 gap-4 mt-4 p-4 bg-green-50 rounded">
                                <div>
                                    <h5 class="font-bold text-green-800 mb-2">üí∞ Investment Benefits:</h5>
                                    <ul class="text-sm text-green-700 space-y-1">
                                        <li>‚Ä¢ Monthly dividend payments</li>
                                        <li>‚Ä¢ Real property investment</li>
                                        <li>‚Ä¢ Transparent profit sharing</li>
                                        <li>‚Ä¢ Long-term passive income</li>
                                    </ul>
                                </div>
                                <div>
                                    <h5 class="font-bold text-green-800 mb-2">üìä Your Investment:</h5>
                                    <ul class="text-sm text-green-700 space-y-1">
                                        <li>‚Ä¢ Investment: ‚Ç±${bestOption.price.toLocaleString()}</li>
                                        <li>‚Ä¢ Remaining budget: ‚Ç±${(budget - bestOption.price).toLocaleString()}</li>
                                        <li>‚Ä¢ Floor level: ${bestOption.name}</li>
                                        <li>‚Ä¢ Available units: ${bestOption.availableCount}</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    ${matchingFloors.length > 1 ? `
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
                            <h4 class="text-lg font-bold text-blue-800 mb-4">üè¢ Other Options Within Your Budget:</h4>
                            <div class="grid gap-3">
                                ${matchingFloors.slice(1).map(floor => `
                                    <div class="bg-white rounded-lg p-4 border border-blue-200 flex justify-between items-center">
                                        <div class="flex items-center gap-3">
                                            <span class="text-2xl">${floor.icon}</span>
                                            <div>
                                                <div class="font-bold text-blue-800">${floor.name} Floor</div>
                                                <div class="text-sm text-blue-600">${floor.availableCount} units available</div>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-lg font-bold text-blue-800">‚Ç±${floor.price.toLocaleString()}</div>
                                            <div class="text-xs text-blue-600">Saves ‚Ç±${(bestOption.price - floor.price).toLocaleString()}</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-yellow-600">üí°</span>
                            <span class="font-bold text-yellow-800">Investment Tip:</span>
                        </div>
                        <p class="text-yellow-700 text-sm">
                            ${budget >= 50000 ? 
                                'Excellent! You can afford our premium Penthouse units with the highest dividend potential.' :
                                budget >= 20000 ?
                                'Great budget! Consider the higher floors for better dividend returns.' :
                                budget >= 5000 ?
                                'Good starting budget! You can access multiple floor options.' :
                                'Perfect for getting started! You can always upgrade to higher floors later.'
                            }
                        </p>
                    </div>
                    
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 text-center">
                        <div class="text-gray-700 mb-2">
                            <strong>Total Available Units in Your Budget:</strong> ${totalAvailable}
                        </div>
                        <div class="text-sm text-gray-600">
                            Click "Invest Now" to proceed with the <strong>${bestOption.name} Floor</strong> investment
                        </div>
                    </div>
                </div>
            `;
            
            container.classList.remove('hidden');
            document.getElementById('investNowBtn').classList.remove('hidden');
            
            // Store recommended slots for investment
            recommendedSlots = availableSlots.filter(slot => slot.price === bestOption.price);
        }

        function proceedToInvestment() {
            if (recommendedSlots.length === 0) {
                alert('No available units found for your budget. Please try a different amount.');
                return;
            }
            
            // Close budget modal
            closeBudgetModal();
            
            // Find the first available slot of the recommended type
            const recommendedSlot = recommendedSlots[0];
            const slotElement = document.querySelector(`[data-slot-id="${recommendedSlot.slotId}"]`);
            
            if (slotElement) {
                // Scroll to the slot
                slotElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // Highlight the slot temporarily
                const originalClass = slotElement.className;
                slotElement.className = originalClass + ' ring-4 ring-purple-500 ring-opacity-75';
                
                setTimeout(() => {
                    slotElement.className = originalClass;
                    // Open investment form for this slot
                    handleSlotClick(recommendedSlot.slotId, slotElement);
                }, 1500);
                
                // Show success message
                setTimeout(() => {
                    alert(`üéØ Perfect! We've found you a ${recommendedSlot.floorName} Floor unit.\n\nUnit: ${recommendedSlot.slotId}\nInvestment: ‚Ç±${recommendedSlot.price.toLocaleString()}\n\nThe investment form will open shortly!`);
                }, 500);
            } else {
                alert('Unit not found. Please try selecting a unit manually from the building.');
            }
        }

        // ===== AFFILIATE FUNCTIONS =====
        function showAffiliateProgram() {
            const modal = document.getElementById('affiliateModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            // Generate a new affiliate number
            generateNewAffiliateNumber();
        }

        function closeAffiliateModal() {
            const modal = document.getElementById('affiliateModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            document.getElementById('affiliateForm').reset();
        }

        function generateNewAffiliateNumber() {
            // Generate a unique 8-digit affiliate number
            let affiliateNumber;
            do {
                affiliateNumber = Math.floor(10000000 + Math.random() * 90000000).toString();
            } while (Object.values(affiliates).some(aff => aff.affiliateNumber === affiliateNumber));
            
            document.getElementById('generatedAffiliateNumber').value = affiliateNumber;
        }

        // Handle affiliate form submission
        document.getElementById('affiliateForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const email = formData.get('affiliateEmail');
            
            // Check if email already exists
            if (affiliates[email]) {
                alert('This email is already registered as an affiliate!');
                return;
            }
            
            const affiliateData = {
                name: formData.get('affiliateName'),
                mobile: formData.get('affiliateMobile'),
                paymentMethod: formData.get('affiliatePayment'),
                accountDetails: formData.get('affiliateAccountDetails'),
                affiliateNumber: document.getElementById('generatedAffiliateNumber').value,
                registrationDate: new Date().toISOString(),
                totalCommissions: 0,
                pendingCommissions: 0,
                totalWithdrawals: 0,
                totalReferrals: 0,
                referrals: [],
                withdrawalHistory: []
            };
            
            affiliates[email] = affiliateData;
            await saveData('affiliates', affiliates);
            
            alert(`üéâ Affiliate registration successful!\n\nYour Affiliate Number: ${affiliateData.affiliateNumber}\n\nSave this number - you'll need it to:\n‚Ä¢ Access your affiliate dashboard\n‚Ä¢ Earn 5% commission on referrals\n\nShare this number with people you refer!`);
            
            closeAffiliateModal();
        });

        function showAffiliateDashboard() {
            const modal = document.getElementById('affiliateDashboardModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            // Reset to login view
            document.getElementById('affiliateDashboardLogin').classList.remove('hidden');
            document.getElementById('affiliateDashboardContent').classList.add('hidden');
            document.getElementById('affiliateDashboardNumber').value = '';
        }

        function closeAffiliateDashboardModal() {
            const modal = document.getElementById('affiliateDashboardModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        function loadAffiliateDashboard() {
            const affiliateNumber = document.getElementById('affiliateDashboardNumber').value.trim();
            if (!affiliateNumber) {
                alert('Please enter your affiliate number');
                return;
            }
            
            // Find affiliate by number
            const affiliateEntry = Object.entries(affiliates).find(([_, aff]) => aff.affiliateNumber === affiliateNumber);
            
            if (!affiliateEntry) {
                alert('Affiliate number not found. Please check your number and try again.');
                return;
            }
            
            const [email, affiliate] = affiliateEntry;
            
            // Update dashboard stats
            document.getElementById('affiliateTotalEarned').textContent = `‚Ç±${((affiliate.totalCommissions || 0) + (affiliate.totalWithdrawals || 0)).toLocaleString()}`;
            document.getElementById('affiliateAvailableBalance').textContent = `‚Ç±${(affiliate.totalCommissions || 0).toLocaleString()}`;
            document.getElementById('affiliatePendingEarnings').textContent = `‚Ç±${(affiliate.pendingCommissions || 0).toLocaleString()}`;
            document.getElementById('affiliateTotalWithdrawn').textContent = `‚Ç±${(affiliate.totalWithdrawals || 0).toLocaleString()}`;
            document.getElementById('affiliateNumber').textContent = affiliate.affiliateNumber;
            document.getElementById('affiliateTotalReferrals').textContent = affiliate.totalReferrals || 0;
            document.getElementById('affiliateWithdrawalCount').textContent = (affiliate.withdrawalHistory || []).length;
            document.getElementById('affiliateNumberToCopy').value = affiliate.affiliateNumber;
            
            // Load referrals list
            const referralsList = document.getElementById('affiliateReferralsList');
            if (affiliate.referrals && affiliate.referrals.length > 0) {
                referralsList.innerHTML = `
                    <h4 class="text-lg font-bold mb-4">üìã Your Referrals</h4>
                    <div class="space-y-3">
                        ${affiliate.referrals.map(ref => `
                            <div class="bg-white border rounded-lg p-4">
                                <div class="flex justify-between items-start">
                                    <div class="flex-1">
                                        <div class="flex items-center gap-2 mb-2">
                                            <span class="font-semibold">${ref.investorName}</span>
                                            <span class="text-sm ${ref.status === 'approved' ? 'bg-green-100 text-green-800' : 'bg-orange-100 text-orange-800'} px-2 py-1 rounded">${ref.status}</span>
                                        </div>
                                        <p class="text-sm text-gray-600">Investment: ‚Ç±${ref.investmentAmount.toLocaleString()}</p>
                                        <p class="text-sm text-gray-600">Your Commission: ‚Ç±${ref.commission.toLocaleString()}</p>
                                        <p class="text-xs text-gray-400">Date: ${new Date(ref.date).toLocaleDateString()}</p>
                    </div>
                </div>
            </div>
        `).join('')}
    </div>
`;
            } else {
                referralsList.innerHTML = `
                    <div class="bg-gray-50 border rounded-lg p-6 text-center">
                        <p class="text-gray-500">No referrals yet. Share your affiliate number to start earning!</p>
                    </div>
                `;
            }
            
            // Show dashboard content
            document.getElementById('affiliateDashboardLogin').classList.add('hidden');
            document.getElementById('affiliateDashboardContent').classList.remove('hidden');
        }

        function copyAffiliateNumber() {
            const numberField = document.getElementById('affiliateNumberToCopy');
            numberField.select();
            document.execCommand('copy');
            alert('Affiliate number copied to clipboard!');
        }

        // ===== ADMIN SETTINGS FUNCTIONS =====
        function loadAdminSettings() {
            const container = document.getElementById('adminSettingsContent');
            container.innerHTML = `
                <div class="space-y-6">
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
                        <h4 class="text-xl font-bold text-blue-800 mb-4">üîê Change Admin Credentials</h4>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">New Username</label>
                                <input type="text" id="newAdminUsername" placeholder="Enter new username" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">New Password</label>
                                <input type="password" id="newAdminPassword" placeholder="Enter new password" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                        <div class="mt-4">
                            <label class="block text-sm font-medium mb-2">Confirm Current Password</label>
                            <input type="password" id="confirmCurrentPassword" placeholder="Enter current password to confirm" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <button onclick="changeAdminCredentials()" class="mt-4 bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 font-semibold">
                            üîÑ Update Credentials
                        </button>
                        <div class="mt-3 text-sm text-blue-600">
                            Current Username: <strong>${adminCredentials.username}</strong>
                        </div>
                    </div>
                    
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6">
                        <h4 class="text-xl font-bold text-yellow-800 mb-4">üìä System Statistics</h4>
                        <div class="grid md:grid-cols-4 gap-4">
                            <div class="text-center">
                                <div class="text-2xl font-bold text-green-600">${Object.keys(investments).length}</div>
                                <div class="text-sm text-gray-600">Total Investments</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-blue-600">${Object.keys(affiliates).length}</div>
                                <div class="text-sm text-gray-600">Total Affiliates</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-purple-600">‚Ç±${Object.values(investments).reduce((sum, inv) => sum + (inv.status === 'approved' ? parseInt(inv.investmentAmount) : 0), 0).toLocaleString()}</div>
                                <div class="text-sm text-gray-600">Total Raised</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-orange-600">‚Ç±${Object.values(affiliates).reduce((sum, aff) => sum + (aff.totalCommissions || 0), 0).toLocaleString()}</div>
                                <div class="text-sm text-gray-600">Total Commissions</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-red-50 border border-red-200 rounded-lg p-6">
                        <h4 class="text-xl font-bold text-red-800 mb-4">‚ö†Ô∏è Danger Zone</h4>
                        <p class="text-red-700 mb-4">These actions are permanent and cannot be undone!</p>
                        <div class="space-y-3">
                            <button onclick="confirmClearAllData()" class="bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 font-semibold w-full">
                                üóëÔ∏è Clear All Investment Data
                            </button>
                            <button onclick="confirmClearAllAffiliates()" class="bg-red-700 text-white px-6 py-3 rounded-lg hover:bg-red-800 font-semibold w-full">
                                üóëÔ∏è Clear All Affiliate Data
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        async function changeAdminCredentials() {
            const newUsername = document.getElementById('newAdminUsername').value.trim();
            const newPassword = document.getElementById('newAdminPassword').value.trim();
            const currentPassword = document.getElementById('confirmCurrentPassword').value.trim();
            
            if (!newUsername || !newPassword || !currentPassword) {
                alert('Please fill in all fields');
                return;
            }
            
            if (currentPassword !== adminCredentials.password) {
                alert('Current password is incorrect!');
                return;
            }
            
            if (newUsername.length < 3) {
                alert('Username must be at least 3 characters long');
                return;
            }
            
            if (newPassword.length < 6) {
                alert('Password must be at least 6 characters long');
                return;
            }
            
            // Update credentials
            adminCredentials.username = newUsername;
            adminCredentials.password = newPassword;
            
            // Save to Firebase
            try {
                await saveToFirebase('admin', 'credentials', adminCredentials);
                alert(`‚úÖ Admin credentials updated successfully!\n\nNew Username: ${newUsername}\nNew Password: ${newPassword}\n\nPlease remember your new credentials!`);
            } catch (error) {
                console.error('Failed to save admin credentials:', error);
                alert('‚ö†Ô∏è Credentials updated locally but failed to save to Firebase. Changes may not persist after refresh.');
            }
            
            // Clear the form
            document.getElementById('newAdminUsername').value = '';
            document.getElementById('newAdminPassword').value = '';
            document.getElementById('confirmCurrentPassword').value = '';
            
            // Refresh the settings page to show new username
            loadAdminSettings();
        }

        function confirmDeleteInvestor(slotId) {
            const investment = investments[slotId];
            if (!investment) {
                alert('Investment not found!');
                return;
            }
            
            const confirmMessage = `‚ö†Ô∏è CONFIRM DELETE INVESTOR ‚ö†Ô∏è\n\n` +
                `Investor: ${investment.fullName}\n` +
                `Email: ${investment.email}\n` +
                `Slot: ${slotId}\n` +
                `Investment Amount: ‚Ç±${parseInt(investment.investmentAmount).toLocaleString()}\n\n` +
                `This action will:\n` +
                `‚Ä¢ PERMANENTLY delete all investor data\n` +
                `‚Ä¢ Remove the slot completely (no green slot)\n` +
                `‚Ä¢ Cannot be undone\n\n` +
                `Type "DELETE" to confirm:`;
            
            const userInput = prompt(confirmMessage);
            
            if (userInput === 'DELETE') {
                deleteInvestor(slotId);
            } else {
                alert('Delete cancelled. Investor data remains unchanged.');
            }
        }

        async function deleteInvestor(slotId) {
            const investment = investments[slotId];
            
            if (!investment) {
                alert('Investment not found!');
                return;
            }
            
            // Handle affiliate commission reversal if applicable
            if (investment.affiliateNumber) {
                let affiliateEmail = null;
                let affiliate = null;
                
                for (const [email, affData] of Object.entries(affiliates)) {
                    if (affData.affiliateNumber === investment.affiliateNumber) {
                        affiliateEmail = email;
                        affiliate = affData;
                        break;
                    }
                }
                
                if (affiliate && affiliateEmail) {
                    if (affiliate.referrals) {
                        const referralIndex = affiliate.referrals.findIndex(ref => ref.slotId === slotId);
                        if (referralIndex !== -1) {
                            const referral = affiliate.referrals[referralIndex];
                            affiliate.totalCommissions = Math.max(0, (affiliate.totalCommissions || 0) - referral.commission);
                            affiliate.totalReferrals = Math.max(0, (affiliate.totalReferrals || 0) - 1);
                            affiliate.referrals.splice(referralIndex, 1);
                        }
                    }
                    
                    affiliates[affiliateEmail] = affiliate;
                    await saveData('affiliates', affiliates);
                }
            }
            
            // Remove the investment completely
            delete investments[slotId];
            await saveData('investments', investments);
            
            // Find and remove the slot element completely
            const slot = document.querySelector(`[data-slot-id="${slotId}"]`);
            if (slot) {
                slot.remove();
            }
            
            // Close photo modal if open for this slot
            if (currentPhotoSlot === slotId) {
                closePhotoModal();
            }
            
            // Refresh displays
            setTimeout(() => {
                updateDashboard();
                if (isAdminLoggedIn) {
                    loadAdminInvestments();
                    loadAdminAffiliates();
                }
            }, 100);
            
            alert(`‚úÖ Investor deleted permanently!\n\nAll data for ${investment.fullName} has been removed from the system.`);
        }

        function confirmDeleteAffiliate(email) {
            const affiliate = affiliates[email];
            if (!affiliate) {
                alert('Affiliate not found!');
                return;
            }
            
            const confirmMessage = `‚ö†Ô∏è CONFIRM DELETE AFFILIATE ‚ö†Ô∏è\n\n` +
                `Affiliate: ${affiliate.name}\n` +
                `Email: ${email}\n` +
                `Affiliate Number: ${affiliate.affiliateNumber}\n` +
                `Total Commissions: ‚Ç±${(affiliate.totalCommissions || 0).toLocaleString()}\n` +
                `Total Referrals: ${affiliate.totalReferrals || 0}\n\n` +
                `This action will:\n` +
                `‚Ä¢ PERMANENTLY delete all affiliate data\n` +
                `‚Ä¢ Remove all referral history\n` +
                `‚Ä¢ Cannot be undone\n\n` +
                `Type "DELETE" to confirm:`;
            
            const userInput = prompt(confirmMessage);
            
            if (userInput === 'DELETE') {
                deleteAffiliate(email);
            } else {
                alert('Delete cancelled. Affiliate data remains unchanged.');
            }
        }

        async function deleteAffiliate(email) {
            const affiliate = affiliates[email];
            
            if (!affiliate) {
                alert('Affiliate not found!');
                return;
            }
            
            // Remove affiliate data
            delete affiliates[email];
            await saveData('affiliates', affiliates);
            
            // Refresh displays
            setTimeout(() => {
                if (isAdminLoggedIn) {
                    loadAdminAffiliates();
                }
            }, 100);
            
            alert(`‚úÖ Affiliate deleted permanently!\n\nAll data for ${affiliate.name} has been removed from the system.`);
        }

        function confirmClearAllData() {
            const confirmMessage = `‚ö†Ô∏è CONFIRM CLEAR ALL INVESTMENT DATA ‚ö†Ô∏è\n\n` +
                `This will permanently delete:\n` +
                `‚Ä¢ All ${Object.keys(investments).length} investments\n` +
                `‚Ä¢ All investor information\n` +
                `‚Ä¢ All dividend records\n` +
                `‚Ä¢ Reset all slots to available\n\n` +
                `This action CANNOT be undone!\n\n` +
                `Type "CLEAR ALL INVESTMENTS" to confirm:`;
            
            const userInput = prompt(confirmMessage);
            
            if (userInput === 'CLEAR ALL INVESTMENTS') {
                clearAllInvestmentData();
            } else {
                alert('Clear cancelled. All data remains unchanged.');
            }
        }

        async function clearAllInvestmentData() {
            investments = {};
            await saveData('investments', investments);
            
            // Reset all slots to available
            initializeBuilding();
            updateDashboard();
            
            if (isAdminLoggedIn) {
                loadAdminInvestments();
            }
            
            alert('‚úÖ All investment data cleared successfully!\nAll slots are now available.');
        }

        function confirmClearAllAffiliates() {
            const confirmMessage = `‚ö†Ô∏è CONFIRM CLEAR ALL AFFILIATE DATA ‚ö†Ô∏è\n\n` +
                `This will permanently delete:\n` +
                `‚Ä¢ All ${Object.keys(affiliates).length} affiliates\n` +
                `‚Ä¢ All referral records\n` +
                `‚Ä¢ All commission history\n\n` +
                `This action CANNOT be undone!\n\n` +
                `Type "CLEAR ALL AFFILIATES" to confirm:`;
            
            const userInput = prompt(confirmMessage);
            
            if (userInput === 'CLEAR ALL AFFILIATES') {
                clearAllAffiliateData();
            } else {
                alert('Clear cancelled. All data remains unchanged.');
            }
        }

        async function clearAllAffiliateData() {
            affiliates = {};
            await saveData('affiliates', affiliates);
            
            if (isAdminLoggedIn) {
                loadAdminAffiliates();
            }
            
            alert('‚úÖ All affiliate data cleared successfully!');
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'985deca715739891',t:'MTc1OTAwNjc2My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
